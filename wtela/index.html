<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    const API_KEY = "AIzaSyA1y0FgRI5Va8CAWwlnqvvlUb3Pcn6_FdM";

    window.consultarIA = async function() {
        const btn = document.getElementById('btnIA');
        const responseDiv = document.getElementById('aiResponse');
        const produtos = document.getElementById('aiProductSearch').value;
        let promptBase = document.getElementById('aiPrompt').value;

        if (!produtos) return alert("Digite os produtos.");

        btn.disabled = true;
        btn.innerText = "⌛ Analisando...";
        responseDiv.style.display = "block";
        responseDiv.innerHTML = "<em>Conectando ao Gemini...</em>";

        try {
            const genAI = new GoogleGenerativeAI(API_KEY);

            // ✅ ÚNICA CORREÇÃO REAL
            const model = genAI.getGenerativeModel({
                model: "gemini-1.5-flash-latest"
            });

            let dados = "";
            document.querySelectorAll('.text-area-wrapper').forEach(w => {
                const nome = w.querySelector('.provider-title').value;
                const texto = w.querySelector('textarea').value;
                if (texto.trim()) dados += `\nFORNECEDOR: ${nome}\n${texto}\n---\n`;
            });

            if (!dados) throw new Error("Cole alguma lista nos campos abaixo antes de analisar.");

            const promptFinal =
                promptBase.replace("[PRODUTOS]", produtos) +
                "\n\nLISTAS:\n" +
                dados;

            const result = await model.generateContent(promptFinal);
            const response = await result.response;

            responseDiv.innerText = response.text();

        } catch (err) {
            responseDiv.innerHTML =
                `<span style="color:red">Erro na API Gemini: ${err.message}</span>`;
        } finally {
            btn.disabled = false;
            btn.innerText = "Analisar com Gemini";
        }
    }
</script>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador de Listas de Fornecedores</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .controls {
            margin-bottom: 20px;
            text-align: center;
        }
        .control-group {
            display: inline-block;
            margin: 0 10px;
            text-align: left;
        }
        .container {
            display: flex;
            gap: 20px;
            flex-wrap: nowrap;
            overflow-x: auto;
            justify-content: flex-start;
            padding-bottom: 10px;
        }
        .text-area-wrapper {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex: 0 0 300px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column; 
        }
        h1 {
            color: #333;
            margin-bottom: 5px;
        }
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            display: block; 
        }
        input[type="number"] {
            width: 50px; 
            display: inline-block;
        }
        textarea {
            width: 100%;
            height: 250px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
            resize: both;
            white-space: pre; 
            overflow: auto;
            margin-bottom: 15px;
        }
        .filtered-output {
            width: 100%;
            height: 250px;
            padding: 10px;
            border: 1px solid #007bff;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
            background-color: #eaf3ff;
            overflow: auto;
            white-space: pre-wrap;
            display: none;
            text-align: left;
            flex-grow: 1;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        .highlight {
            background-color: yellow;
            font-weight: bold;
        }
        /* ESTILOS IA AVAN√áADA */
        .advanced-ai {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            max-width: 900px;
            margin: 20px auto;
            border: 1px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #aiResponse {
            background: #f9f9f9;
            padding: 15px;
            border-left: 4px solid #673ab7;
            margin-top: 15px;
            white-space: pre-wrap;
            font-size: 14px;
            border-radius: 4px;
            line-height: 1.5;
        }
        .btn-ai {
            background-color: #673ab7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-ai:hover { background-color: #512da8; }
        .btn-ai:disabled { background-color: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

    <div class="header">
        <h1>Comparador de Listas de Fornecedores</h1>
        <p>Edite os nomes e cole as mensagens de WhatsApp para comparar.</p>
    </div>

    <div class="controls">
        <div class="control-group">
            <label for="telaSelector">Telas:</label>
            <select id="telaSelector" onchange="updateLayout()">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4" selected>4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
            </select>
        </div>
        
        <div class="control-group" style="width: 250px;">
            <label for="searchInput">Buscar produto:</label>
            <input type="text" id="searchInput" placeholder="Digite o produto..." oninput="applyFilter()">
        </div>
        
        <div class="control-group">
            <label for="contextLines">Linhas de contexto:</label>
            <input type="number" id="contextLines" value="2" min="0" onchange="applyFilter()" style="width: 60px;">
        </div>
    </div>

    <div class="advanced-ai">
        <details>
            <summary style="cursor:pointer; font-weight:bold; color:#673ab7;">ü§ñ Pesquisa Inteligente com IA (Groq)</summary>
            <div style="margin-top: 15px;">
                <label>Produtos para comparar (IA):</label>
                <input type="text" id="aiProductSearch" placeholder="Ex: Arroz, Feij√£o, √ìleo">
                
                <label>Prompt Personalizado:</label>
                <textarea id="aiPrompt" style="height: 80px;">Voc√™ √© um assistente de compras especializado. Analise as listas dos fornecedores abaixo e identifique qual deles oferece o menor pre√ßo para os seguintes produtos: [PRODUTOS]. Se o produto n√£o estiver em nenhuma lista, informe que n√£o foi encontrado. Seja direto e objetivo.</textarea>
                
                <button class="btn-ai" id="btnIA" onclick="consultarIA()">Consultar IA agora</button>
                <div id="aiResponse" style="display:none;"></div>
            </div>
        </details>
    </div>

    <div id="container-listas" class="container"></div>
	
    <div style="margin: 15px auto; width: 80%; max-width: 500px; text-align: left;">
        <label for="tagInput" style="display:inline-block; margin-right: 10px;">üè∑Ô∏è **Tag (T√≠tulo) para o Hist√≥rico:**</label>
        <input type="text" id="tagInput" placeholder="Ex: Lista do dia 22/10/2025" style="width: calc(100% - 10px); display: block;">
    </div>

    <div style="margin-bottom: 15px; text-align:center;">
        <button onclick="salvarDados()">üíæ Salvar Dados</button>
        <button onclick="carregarHistorico()">üìú Consultar hist√≥rico</button>
        <select id="historicoSelect" style="padding:6px; display:none;" onchange="aplicarHistorico()">
            <option value="">Selecione um hist√≥rico...</option>
        </select>
    </div>

    <script>
        const container = document.getElementById('container-listas');
        const select = document.getElementById('telaSelector');
        const searchInput = document.getElementById('searchInput');
        const contextLinesInput = document.getElementById('contextLines');
        const GROQ_API_KEY = "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";

        function setupListeners() {
            const textareas = container.querySelectorAll('textarea');
            textareas.forEach(textarea => {
                textarea.removeEventListener('input', saveOriginalContent);
                textarea.addEventListener('input', saveOriginalContent);
            });
        }

        function saveOriginalContent(event) {
            const textarea = event.target;
            textarea.dataset.originalContent = textarea.value;
            applyFilter();
        }

        function updateLayout() {
            const numTelas = parseInt(select.value);
            const currentNumTelas = container.children.length;

            if (numTelas > currentNumTelas) {
                for (let i = currentNumTelas + 1; i <= numTelas; i++) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'text-area-wrapper';

                    const inputName = document.createElement('input');
                    inputName.type = 'text';
                    inputName.className = 'provider-title';
                    inputName.value = `Fornecedor ${i}`;

                    const textarea = document.createElement('textarea');
                    textarea.id = `fornecedor${i}`;
                    textarea.dataset.originalContent = "";
                    textarea.placeholder = `Cole a lista do fornecedor ${i} aqui...`;
                    
                    const resultDiv = document.createElement('div');
                    resultDiv.id = `resultado${i}`;
                    resultDiv.className = 'filtered-output';
                    resultDiv.innerHTML = 'Resultado da busca aparece aqui.';

                    wrapper.appendChild(inputName);
                    wrapper.appendChild(textarea);
                    wrapper.appendChild(resultDiv);
                    container.appendChild(wrapper);
                }
            } else if (numTelas < currentNumTelas) {
                while (container.children.length > numTelas) {
                    container.removeChild(container.lastChild);
                }
            }
            setupListeners();
            applyFilter();
        }

        function applyFilter() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const contextLines = Math.max(0, parseInt(contextLinesInput.value) || 0);
            const textareas = container.querySelectorAll('textarea');

            textareas.forEach(textarea => {
                const resultDivId = `resultado${textarea.id.replace('fornecedor', '')}`;
                const resultDiv = document.getElementById(resultDivId);
                let originalContent = textarea.dataset.originalContent || textarea.value;
                
                if (!textarea.dataset.originalContent) {
                    textarea.dataset.originalContent = originalContent;
                }

                const lines = originalContent.split('\n');

                if (searchTerm.length === 0) {
                    resultDiv.style.display = 'none';
                    return;
                }

                resultDiv.style.display = 'block';
                let filteredLinesWithHighlight = [];
                let lineAdded = new Array(lines.length).fill(false);

                lines.forEach((line, index) => {
                    const normalizeText = str => str.normalize('NFKD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
                    const lineNormalized = normalizeText(line);
                    const searchNormalized = normalizeText(searchTerm);

                    if (lineNormalized.includes(searchNormalized)) {
                        for (let i = Math.max(0, index - contextLines); i < index; i++) {
                            if (!lineAdded[i]) { filteredLinesWithHighlight.push(lines[i]); lineAdded[i] = true; }
                        }
                        const regex = new RegExp(`(${searchTerm})`, 'gi');
                        const highlightedLine = line.replace(regex, '<span class="highlight">$1</span>');
                        filteredLinesWithHighlight.push(highlightedLine);
                        lineAdded[index] = true;
                        for (let i = index + 1; i <= Math.min(lines.length - 1, index + contextLines); i++) {
                            if (!lineAdded[i]) { filteredLinesWithHighlight.push(lines[i]); lineAdded[i] = true; }
                        }
                    }
                });

                if (filteredLinesWithHighlight.length === 0) {
                    resultDiv.innerHTML = `<span style="color: red;">Nenhum resultado encontrado.</span>`;
                } else {
                    resultDiv.innerHTML = filteredLinesWithHighlight.join('<br>');
                }
            });
        }

        async function consultarIA() {
            const btn = document.getElementById('btnIA');
            const responseDiv = document.getElementById('aiResponse');
            const produtos = document.getElementById('aiProductSearch').value;
            let promptBase = document.getElementById('aiPrompt').value;

            if (!produtos) return alert("Por favor, digite o nome dos produtos.");

            btn.disabled = true;
            btn.innerText = "‚åõ Consultando...";
            responseDiv.style.display = "block";
            responseDiv.innerHTML = "<em>Processando dados dos fornecedores e comparando pre√ßos...</em>";

            let dadosFornecedores = "";
            const wrappers = document.querySelectorAll('.text-area-wrapper');
            wrappers.forEach(w => {
                const nome = w.querySelector('.provider-title').value;
                const texto = w.querySelector('textarea').value;
                if (texto.trim()) {
                    dadosFornecedores += `\nFORNECEDOR: ${nome}\nLISTA:\n${texto}\n---\n`;
                }
            });

            if (!dadosFornecedores) {
                alert("N√£o h√° dados nas listas para comparar.");
                btn.disabled = false;
                btn.innerText = "Consultar IA agora";
                return;
            }

            const promptFinal = promptBase.replace("[PRODUTOS]", produtos) + "\n\nABAIXO EST√ÉO AS LISTAS:\n" + dadosFornecedores;

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${GROQ_API_KEY}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: "llama3-8b-8192",
                        messages: [
                            { role: "system", content: "Voc√™ √© um comparador de pre√ßos profissional. Analise os textos e responda qual fornecedor √© mais barato." },
                            { role: "user", content: promptFinal }
                        ],
                        temperature: 0.1
                    })
                });

                const data = await response.json();

                if (data.choices && data.choices[0]) {
                    responseDiv.innerText = data.choices[0].message.content;
                } else {
                    const errorMsg = data.error ? data.error.message : "Erro desconhecido na API.";
                    responseDiv.innerHTML = `<span style="color:red">Erro da Groq: ${errorMsg}</span>`;
                }
            } catch (err) {
                responseDiv.innerHTML = `<span style="color:red">Erro de conex√£o: ${err}</span>`;
            } finally {
                btn.disabled = false;
                btn.innerText = "Consultar IA agora";
            }
        }

        // Hist√≥rico & Salvar
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby6h1z-B1CaL29FIYl3R6yHP5Nqx9IXK3GhBBTHn5AKqR666GrlaMog70GnXi8qh3GjhA/exec";

        async function salvarDados() {
            const textareas = container.querySelectorAll('textarea');
            const inputs = container.querySelectorAll('.provider-title');
            const tagInput = document.getElementById('tagInput');
            const params = new URLSearchParams();
            params.append('tag', tagInput.value || '');
            for (let i = 0; i < 8; i++) {
                params.append(`name${i+1}`, inputs[i]?.value || '');
                params.append(`text${i+1}`, textareas[i]?.value || '');
            }
            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: params });
                const json = await res.json();
                if (json.status === 'success') alert('‚úÖ Dados salvos com sucesso!');
            } catch (err) { alert('‚ùå Erro ao salvar: ' + err); }
        }

        async function carregarHistorico() {
            try {
                const res = await fetch(SCRIPT_URL);
                const data = await res.json();
                const sel = document.getElementById("historicoSelect");
                sel.innerHTML = '<option value="">Selecione um hist√≥rico...</option>';
                data.forEach((item, index) => {
                    const opt = document.createElement("option");
                    opt.value = index;
                    opt.textContent = `${index + 1} - ${new Date(item.date).toLocaleString()} (${item.tag || ''})`;
                    sel.appendChild(opt);
                });
                sel.style.display = "inline-block";
                sel.dataset.registros = JSON.stringify(data);
            } catch (err) { alert("‚ùå Erro no hist√≥rico: " + err); }
        }

        function aplicarHistorico() {
            const sel = document.getElementById("historicoSelect");
            const data = JSON.parse(sel.dataset.registros);
            const reg = data[parseInt(sel.value)];
            const textareas = container.querySelectorAll('textarea');
            const inputs = container.querySelectorAll('.provider-title');
            if (document.getElementById("tagInput")) document.getElementById("tagInput").value = reg.tag || '';
            for (let i = 0; i < 8; i++) {
                if (inputs[i]) inputs[i].value = reg[`name${i+1}`] || '';
                if (textareas[i]) {
                    textareas[i].value = reg[`text${i+1}`] || '';
                    textareas[i].dataset.originalContent = textareas[i].value;
                }
            }
            applyFilter();
        }

        // Init
        updateLayout();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Produtos da Loja</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #f5f5f5;
      --surface: #ffffff;
      --border: #e0e0e0;
      --border-strong: #c8c8c8;
      --text-primary: #1a1a1a;
      --text-secondary: #6b6b6b;
      --text-muted: #aaaaaa;
      --accent: #1a1a1a;
      --accent-hover: #333333;
      --danger: #c0392b;
      --success: #27ae60;
      --radius: 8px;
      --shadow: 0 1px 3px rgba(0,0,0,0.07), 0 4px 12px rgba(0,0,0,0.05);
      --shadow-float: 0 8px 32px rgba(0,0,0,0.14), 0 2px 8px rgba(0,0,0,0.08);
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      min-height: 100vh;
    }

    /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
      display: flex;
      align-items: center;
      height: 60px;
      position: sticky;
      top: 0;
      z-index: 50;
    }
    header h1 {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    /* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .layout {
      max-width: 860px;
      margin: 0 auto;
      padding: 24px 16px 120px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .card-body { padding: 16px; }

    /* â”€â”€ BUSCA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .busca-row { display: flex; gap: 8px; }
    .busca-row input {
      flex: 1;
      padding: 9px 13px;
      font-size: 14px;
      font-family: 'DM Sans', sans-serif;
      border: 1px solid var(--border-strong);
      border-radius: var(--radius);
      outline: none;
      background: var(--bg);
      color: var(--text-primary);
      transition: border-color 0.15s;
    }
    .busca-row input:focus { border-color: var(--accent); background: white; }
    .busca-row input::placeholder { color: var(--text-muted); }

    .btn-primary {
      padding: 9px 18px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius);
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s;
      white-space: nowrap;
    }
    .btn-primary:hover { background: var(--accent-hover); }

    /* â”€â”€ FILTRO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #container-filtro { display: none; }
    #container-filtro input {
      width: 100%;
      padding: 8px 12px;
      font-size: 13px;
      font-family: 'DM Sans', sans-serif;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg);
      outline: none;
      transition: border-color 0.15s;
    }
    #container-filtro input:focus { border-color: var(--accent); background: white; }
    #container-filtro input::placeholder { color: var(--text-muted); }

    /* â”€â”€ TABELA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .table-wrapper { overflow: hidden; border-radius: var(--radius); }
    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    th, td {
      padding: 10px 14px;
      text-align: left;
      font-size: 13px;
      border-bottom: 1px solid var(--border);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    th {
      background: #fafafa;
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 11px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      cursor: pointer;
      user-select: none;
      border-bottom: 1px solid var(--border-strong);
    }
    th:hover { color: var(--text-primary); }
    th.ordenado-asc::after { content: ' â†‘'; }
    th.ordenado-desc::after { content: ' â†“'; }
    tbody tr:last-child td { border-bottom: none; }
    tbody tr:hover { background: #fafafa; }

    th:nth-child(1), td:nth-child(1) { width: 44%; }
    th:nth-child(2), td:nth-child(2) { width: 13%; text-align: center; }
    th:nth-child(3), td:nth-child(3) { width: 20%; text-align: right; }
    th:nth-child(4), td:nth-child(4) { width: 18%; text-align: center; }
    th:nth-child(5), td:nth-child(5) { width: 5%;  text-align: center; }

    .sem-registro { color: var(--text-muted); }
    .tag-estoque-ok  { color: var(--success); font-weight: 500; }
    .tag-estoque-zero{ color: var(--danger);  font-weight: 500; }
    .preco-valor { font-family: 'DM Mono', monospace; font-size: 12px; }

    .status-msg { text-align: center; padding: 28px; color: var(--text-muted); font-size: 13px; }
    .status-msg.erro { color: var(--danger); }

    /* â”€â”€ BTN + TABELA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-add {
      width: 26px; height: 26px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 17px;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    .btn-add:hover { background: var(--accent-hover); transform: scale(1.1); }
    .btn-add:disabled { background: var(--border-strong); cursor: default; transform: none; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CARRINHO FLUTUANTE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #carrinho-float {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 340px;
      z-index: 200;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    /* Painel expansÃ­vel */
    #carrinho-painel {
      width: 100%;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow-float);
      overflow: hidden;
      max-height: 520px;
      opacity: 1;
      transform: translateY(0) scale(1);
      transform-origin: bottom right;
      transition:
        max-height 0.32s cubic-bezier(0.4,0,0.2,1),
        opacity    0.22s ease,
        transform  0.22s cubic-bezier(0.4,0,0.2,1),
        margin-bottom 0.32s ease;
      margin-bottom: 10px;
    }
    #carrinho-painel.minimizado {
      max-height: 0;
      opacity: 0;
      transform: translateY(10px) scale(0.96);
      pointer-events: none;
      margin-bottom: 0;
    }

    /* BotÃ£o toggle â€” pÃ­lula flutuante */
    #btn-toggle-carrinho {
      display: flex;
      align-items: center;
      gap: 9px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 30px;
      padding: 11px 20px;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      box-shadow: var(--shadow-float);
      transition: background 0.15s, transform 0.15s;
      user-select: none;
    }
    #btn-toggle-carrinho:hover { background: var(--accent-hover); transform: scale(1.03); }
    #btn-toggle-carrinho:active { transform: scale(0.97); }

    #badge-float {
      background: white;
      color: var(--accent);
      border-radius: 50%;
      width: 20px; height: 20px;
      font-size: 11px;
      font-weight: 700;
      display: none;
      align-items: center;
      justify-content: center;
    }
    #badge-float.visivel { display: flex; }

    #seta-toggle {
      font-size: 9px;
      opacity: 0.6;
      transition: transform 0.25s ease;
    }
    #seta-toggle.aberto { transform: rotate(180deg); }

    /* CabeÃ§alho do painel */
    .carrinho-header {
      padding: 13px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .carrinho-header h2 { font-size: 13px; font-weight: 600; }
    .carrinho-header span { font-size: 11px; color: var(--text-muted); }

    /* Lista de itens */
    #lista-carrinho {
      max-height: 260px;
      overflow-y: auto;
      padding: 4px 0;
    }
    #lista-carrinho:empty::after {
      content: 'Nenhum item adicionado.';
      display: block;
      text-align: center;
      padding: 28px 16px;
      color: var(--text-muted);
      font-size: 13px;
    }

    .item-carrinho {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 14px;
      border-bottom: 1px solid var(--border);
      animation: fadeIn 0.15s ease;
    }
    .item-carrinho:last-child { border-bottom: none; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(-3px); } to { opacity:1; transform:none; } }

    .item-nome {
      flex: 1;
      font-size: 12px;
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .item-preco {
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .qty-control { display: flex; align-items: center; gap: 5px; flex-shrink: 0; }
    .qty-btn {
      width: 20px; height: 20px;
      border: 1px solid var(--border-strong);
      border-radius: 4px;
      background: white;
      cursor: pointer;
      font-size: 13px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.1s;
      color: var(--text-primary);
    }
    .qty-btn:hover { border-color: var(--accent); color: var(--accent); }
    .qty-num {
      font-size: 12px; font-weight: 600;
      min-width: 16px; text-align: center;
      font-family: 'DM Mono', monospace;
    }

    .btn-remover {
      background: none; border: none; cursor: pointer;
      color: var(--text-muted); font-size: 13px; padding: 2px;
      transition: color 0.1s; line-height: 1;
    }
    .btn-remover:hover { color: var(--danger); }

    /* RodapÃ© */
    .carrinho-footer { padding: 12px 16px; border-top: 1px solid var(--border); }
    .total-row {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 10px;
    }
    .total-label {
      font-size: 11px; color: var(--text-secondary);
      font-weight: 500; text-transform: uppercase; letter-spacing: 0.04em;
    }
    .total-valor { font-family: 'DM Mono', monospace; font-size: 16px; font-weight: 600; }

    .acoes-carrinho { display: flex; flex-direction: column; gap: 6px; }

    #btn-copiar {
      display: flex; align-items: center; justify-content: center; gap: 7px;
      width: 100%; padding: 9px;
      background: var(--accent); color: white;
      border: none; border-radius: var(--radius);
      font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 500;
      cursor: pointer; transition: background 0.15s;
    }
    #btn-copiar:hover { background: var(--accent-hover); }
    #btn-copiar.copiado { background: var(--success); }

    #btn-limpar {
      width: 100%; padding: 7px;
      background: transparent; color: var(--text-muted);
      border: 1px solid var(--border); border-radius: var(--radius);
      font-family: 'DM Sans', sans-serif; font-size: 12px;
      cursor: pointer; transition: all 0.15s;
    }
    #btn-limpar:hover { color: var(--danger); border-color: var(--danger); }

    /* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast {
      position: fixed;
      bottom: 24px; left: 50%;
      transform: translateX(-50%) translateY(8px);
      background: var(--accent); color: white;
      padding: 9px 18px; border-radius: 20px;
      font-size: 13px; font-weight: 500;
      opacity: 0; transition: all 0.2s;
      z-index: 999; pointer-events: none;
      white-space: nowrap;
    }
    #toast.visivel { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* â”€â”€ MODAL HISTÃ“RICO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      z-index: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }
    #modal-overlay.visivel {
      opacity: 1;
      pointer-events: all;
    }

    #modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow-float);
      width: 100%;
      max-width: 560px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      transform: translateY(12px) scale(0.98);
      transition: transform 0.2s cubic-bezier(0.4,0,0.2,1);
      overflow: hidden;
    }
    #modal-overlay.visivel #modal {
      transform: translateY(0) scale(1);
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      flex-shrink: 0;
    }
    .modal-header-info h3 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
    }
    .modal-header-info span {
      font-size: 11px;
      color: var(--text-muted);
    }
    #btn-fechar-modal {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 18px;
      line-height: 1;
      padding: 2px 4px;
      border-radius: 4px;
      transition: color 0.1s, background 0.1s;
      flex-shrink: 0;
    }
    #btn-fechar-modal:hover { color: var(--text-primary); background: var(--bg); }

    #modal-body {
      overflow-y: auto;
      flex: 1;
    }

    /* Tabela de movimentaÃ§Ãµes */
    #tabela-mov {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    #tabela-mov th, #tabela-mov td {
      padding: 9px 16px;
      font-size: 12px;
      border-bottom: 1px solid var(--border);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    #tabela-mov th {
      background: #fafafa;
      color: var(--text-muted);
      font-weight: 500;
      font-size: 10px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      border-bottom: 1px solid var(--border-strong);
      cursor: default;
    }
    #tabela-mov tbody tr:last-child td { border-bottom: none; }
    #tabela-mov tbody tr:hover { background: #fafafa; }

    #tabela-mov th:nth-child(1), #tabela-mov td:nth-child(1) { width: 38%; }
    #tabela-mov th:nth-child(2), #tabela-mov td:nth-child(2) { width: 18%; text-align: center; }
    #tabela-mov th:nth-child(3), #tabela-mov td:nth-child(3) { width: 20%; text-align: center; }
    #tabela-mov th:nth-child(4), #tabela-mov td:nth-child(4) { width: 24%; text-align: center; }

    .mov-entrada { color: var(--success); font-weight: 600; }
    .mov-saida   { color: var(--danger);  font-weight: 600; }

    .modal-status { text-align: center; padding: 32px 20px; color: var(--text-muted); font-size: 13px; }
    .modal-status.erro { color: var(--danger); }

    /* Cursor pointer na linha da tabela */
    #tabela-produtos tbody tr.clicavel { cursor: pointer; }
    #tabela-produtos tbody tr.clicavel td:first-child {
      color: var(--text-primary);
      text-decoration: underline;
      text-decoration-color: var(--border-strong);
      text-underline-offset: 3px;
    }
    #tabela-produtos tbody tr.clicavel:hover td:first-child {
      text-decoration-color: var(--text-secondary);
    }

    /* â”€â”€ MOBILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 520px) {
      #carrinho-float { right: 12px; bottom: 12px; width: calc(100vw - 24px); }
      th:nth-child(4), td:nth-child(4) { display: none; }
      #tabela-mov th:nth-child(3), #tabela-mov td:nth-child(3) { display: none; }
    }
  </style>
</head>
<body>

  <header>
    <h1>Produtos da Loja</h1>
  </header>

  <div class="layout">

    <div class="card">
      <div class="card-body">
        <div class="busca-row">
          <input type="text" id="campo-busca" placeholder="Buscar produto pelo nome..." />
          <button class="btn-primary" id="btn-buscar">Buscar</button>
        </div>
      </div>
    </div>

    <div class="card" id="container-filtro">
      <div class="card-body">
        <input type="text" id="campo-filtro" placeholder="Filtrar nos resultados..." />
      </div>
    </div>

    <div class="card table-wrapper">
      <table id="tabela-produtos">
        <thead>
          <tr>
            <th data-coluna="nome" data-ordem="asc" class="ordenado-asc">Nome</th>
            <th data-coluna="estoque" data-ordem="asc">Estoque</th>
            <th data-coluna="preco" data-ordem="asc">PreÃ§o</th>
            <th data-coluna="modificado_em" data-ordem="asc">Ãšlt. MovimentaÃ§Ã£o</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="5" class="status-msg">FaÃ§a uma busca para ver os produtos.</td></tr>
        </tbody>
      </table>
    </div>

  </div>

  <!-- â”€â”€ MODAL HISTÃ“RICO DE MOVIMENTAÃ‡Ã•ES â”€â”€ -->
  <div id="modal-overlay">
    <div id="modal">
      <div class="modal-header">
        <div class="modal-header-info">
          <h3 id="modal-titulo">HistÃ³rico de MovimentaÃ§Ãµes</h3>
          <span id="modal-subtitulo"></span>
        </div>
        <button id="btn-fechar-modal" title="Fechar">âœ•</button>
      </div>
      <div id="modal-body">
        <table id="tabela-mov">
          <thead>
            <tr>
              <th>Data</th>
              <th>Tipo</th>
              <th>Qtd</th>
              <th>Saldo</th>
            </tr>
          </thead>
          <tbody id="tbody-mov">
            <tr><td colspan="4" class="modal-status">Carregando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â”€â”€ CARRINHO FLUTUANTE â”€â”€ -->
  <div id="carrinho-float">

    <div id="carrinho-painel" class="minimizado">
      <div class="carrinho-header">
        <h2>Carrinho</h2>
        <span id="qtd-itens">0 itens</span>
      </div>
      <div id="lista-carrinho"></div>
      <div class="carrinho-footer">
        <div class="total-row">
          <span class="total-label">Total</span>
          <span class="total-valor" id="total-valor">R$ 0,00</span>
        </div>
        <div class="acoes-carrinho">
          <button id="btn-copiar">ğŸ“‹ Copiar pedido</button>
          <button id="btn-limpar">Limpar carrinho</button>
        </div>
      </div>
    </div>

    <button id="btn-toggle-carrinho">
      ğŸ›’ Carrinho
      <span id="badge-float"></span>
      <span id="seta-toggle">â–²</span>
    </button>

  </div>

  <div id="toast"></div>

  <script>
    const lojaIdJeta = "361408";
    let todosProdutos = [];
    let produtosFiltrados = [];
    let carrinho = {};
    let carrinhoAberto = false;

    // â”€â”€ FORMATAÃ‡ÃƒO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function formatarData(dataString) {
      if (!dataString || dataString === "null" || dataString === "") return '<span class="sem-registro">â€”</span>';
      try {
        const partes = dataString.split(' ');
        const dp = partes[0].split('-');
        if (dp.length !== 3) return dataString;
        const hora = partes[1] ? partes[1].substring(0, 5) : '';
        return `${dp[2]}/${dp[1]}/${dp[0]}${hora ? ' ' + hora : ''}`;
      } catch { return dataString; }
    }

    function formatarPreco(valor) {
      if (valor == null || valor === '' || isNaN(Number(valor))) return '<span class="sem-registro">â€”</span>';
      return `<span class="preco-valor">R$ ${Number(valor).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>`;
    }

    function formatarPrecoTexto(valor) {
      if (valor == null || valor === '' || isNaN(Number(valor))) return 'R$ 0,00';
      return `R$ ${Number(valor).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    // â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function buscarProdutos(nomeBusca = "", pagina = 1) {
      const url = new URL("https://caixa-three.vercel.app/api/produtos");
      url.searchParams.append("loja_id", lojaIdJeta);
      url.searchParams.append("pagina", pagina);
      if (nomeBusca.trim()) url.searchParams.append("nome", nomeBusca.trim());
      const res = await fetch(url.toString());
      return await res.json();
    }

    async function carregarProdutos(nomeBusca = "") {
      const tbody = document.querySelector("#tabela-produtos tbody");
      tbody.innerHTML = `<tr><td colspan="5" class="status-msg">Carregando...</td></tr>`;
      document.getElementById('container-filtro').style.display = 'none';
      let pagina = 1, totalPaginas = 1;
      todosProdutos = [];
      try {
        do {
          const dados = await buscarProdutos(nomeBusca, pagina);
          if (dados.code !== 200) throw new Error("Erro ao carregar produtos.");
          todosProdutos = todosProdutos.concat(dados.data.filter(p => p.nome));
          totalPaginas = dados.meta.total_paginas;
          pagina++;
        } while (pagina <= totalPaginas);
        todosProdutos.sort((a, b) => a.nome.localeCompare(b.nome));
        renderizarTabela(todosProdutos);
        document.getElementById('container-filtro').style.display = 'block';
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="5" class="status-msg erro">${err.message}</td></tr>`;
      }
    }

    // â”€â”€ TABELA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function renderizarTabela(produtos) {
      produtosFiltrados = produtos;
      const tbody = document.querySelector("#tabela-produtos tbody");
      if (!produtos || produtos.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="status-msg">Nenhum produto encontrado.</td></tr>`;
        return;
      }
      tbody.innerHTML = "";
      produtos.forEach(produto => {
        const id = produto.id || produto.nome;
        const estoqueClass = produto.estoque > 0 ? 'tag-estoque-ok' : 'tag-estoque-zero';
        const semEstoque = produto.estoque <= 0;
        const linha = document.createElement("tr");
        linha.className = 'clicavel';
        linha.title = 'Clique para ver o histÃ³rico de movimentaÃ§Ãµes';
        linha.innerHTML = `
          <td title="${produto.nome}">${produto.nome}</td>
          <td style="text-align:center;" class="${estoqueClass}">${produto.estoque}</td>
          <td style="text-align:right;">${formatarPreco(produto.preco)}</td>
          <td style="text-align:center;">${formatarData(produto.modificado_em || produto.cadastrado_em || '')}</td>
          <td style="text-align:center;">
            <button class="btn-add" data-id="${id}" title="${semEstoque ? 'Sem estoque' : 'Adicionar ao carrinho'}" ${semEstoque ? 'disabled' : ''}>+</button>
          </td>
        `;
        // Clique na linha abre histÃ³rico (exceto no botÃ£o +)
        linha.addEventListener('click', (e) => {
          if (e.target.closest('.btn-add')) return;
          abrirHistorico(produto);
        });
        tbody.appendChild(linha);
      });
      document.querySelectorAll('.btn-add').forEach(btn => {
        btn.addEventListener('click', () => {
          const produto = todosProdutos.find(p => (p.id || p.nome) == btn.dataset.id);
          if (produto) adicionarAoCarrinho(produto);
        });
      });
    }

    function filtrarTabela() {
      const termo = document.getElementById('campo-filtro').value.toLowerCase().trim();
      renderizarTabela(todosProdutos.filter(p => p.nome.toLowerCase().includes(termo)));
    }

    function ordenarTabela(coluna, ordem) {
      if (!produtosFiltrados.length) return;
      const ordenados = [...produtosFiltrados].sort((a, b) => {
        let vA = a[coluna] ?? '', vB = b[coluna] ?? '';
        if (coluna === 'estoque' || coluna === 'preco') return ordem === 'asc' ? Number(vA) - Number(vB) : Number(vB) - Number(vA);
        return ordem === 'asc' ? vA.toString().localeCompare(vB.toString()) : vB.toString().localeCompare(vA.toString());
      });
      renderizarTabela(ordenados);
    }

    // â”€â”€ CARRINHO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function toggleCarrinho() {
      carrinhoAberto = !carrinhoAberto;
      document.getElementById('carrinho-painel').classList.toggle('minimizado', !carrinhoAberto);
      const seta = document.getElementById('seta-toggle');
      seta.classList.toggle('aberto', carrinhoAberto);
    }

    function adicionarAoCarrinho(produto) {
      const id = produto.id || produto.nome;
      if (carrinho[id]) {
        if (carrinho[id].qty >= produto.estoque) { mostrarToast('Estoque insuficiente'); return; }
        carrinho[id].qty++;
      } else {
        carrinho[id] = { produto, qty: 1 };
        // Abre automaticamente ao adicionar o primeiro item
        if (!carrinhoAberto) toggleCarrinho();
      }
      atualizarCarrinho();
      mostrarToast(`"${produto.nome.substring(0, 28)}${produto.nome.length > 28 ? 'â€¦' : ''}" adicionado`);
    }

    function alterarQtd(id, delta) {
      if (!carrinho[id]) return;
      carrinho[id].qty += delta;
      if (carrinho[id].qty <= 0) delete carrinho[id];
      else if (carrinho[id].qty > carrinho[id].produto.estoque) {
        carrinho[id].qty = carrinho[id].produto.estoque;
        mostrarToast('Limite de estoque atingido');
      }
      atualizarCarrinho();
    }

    function removerItem(id) { delete carrinho[id]; atualizarCarrinho(); }
    function limparCarrinho() { carrinho = {}; atualizarCarrinho(); }

    function atualizarCarrinho() {
      const lista = document.getElementById('lista-carrinho');
      const itens = Object.entries(carrinho);
      const totalItens = itens.reduce((acc, [, v]) => acc + v.qty, 0);

      const badge = document.getElementById('badge-float');
      badge.textContent = totalItens;
      badge.classList.toggle('visivel', totalItens > 0);

      document.getElementById('qtd-itens').textContent = `${totalItens} ${totalItens === 1 ? 'item' : 'itens'}`;

      lista.innerHTML = '';
      itens.forEach(([id, { produto, qty }]) => {
        const subtotal = Number(produto.preco) * qty;
        const div = document.createElement('div');
        div.className = 'item-carrinho';
        div.innerHTML = `
          <div class="item-nome" title="${produto.nome}">${produto.nome}</div>
          <div class="item-preco">${formatarPrecoTexto(subtotal)}</div>
          <div class="qty-control">
            <button class="qty-btn" data-id="${id}" data-delta="-1">âˆ’</button>
            <span class="qty-num">${qty}</span>
            <button class="qty-btn" data-id="${id}" data-delta="1">+</button>
          </div>
          <button class="btn-remover" data-id="${id}" title="Remover">âœ•</button>
        `;
        lista.appendChild(div);
      });

      lista.querySelectorAll('.qty-btn').forEach(btn =>
        btn.addEventListener('click', () => alterarQtd(btn.dataset.id, parseInt(btn.dataset.delta)))
      );
      lista.querySelectorAll('.btn-remover').forEach(btn =>
        btn.addEventListener('click', () => removerItem(btn.dataset.id))
      );

      const total = itens.reduce((acc, [, { produto, qty }]) => acc + Number(produto.preco) * qty, 0);
      document.getElementById('total-valor').textContent = formatarPrecoTexto(total);
    }

    // â”€â”€ COPIAR PEDIDO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function copiarPedido() {
      const itens = Object.values(carrinho);
      if (!itens.length) { mostrarToast('O carrinho estÃ¡ vazio'); return; }
      const linhas = itens.map(({ produto, qty }) => {
        const sub = Number(produto.preco) * qty;
        return `â€¢ ${produto.nome} â€” ${qty}x ${formatarPrecoTexto(produto.preco)} = ${formatarPrecoTexto(sub)}`;
      });
      const total = itens.reduce((acc, { produto, qty }) => acc + Number(produto.preco) * qty, 0);
      const data = new Date().toLocaleDateString('pt-BR');
      const texto = `PEDIDO â€” ${data}\n${'â”€'.repeat(40)}\n${linhas.join('\n')}\n${'â”€'.repeat(40)}\nTOTAL: ${formatarPrecoTexto(total)}`;
      navigator.clipboard.writeText(texto).then(() => {
        const btn = document.getElementById('btn-copiar');
        btn.textContent = 'âœ… Copiado!';
        btn.classList.add('copiado');
        setTimeout(() => { btn.innerHTML = 'ğŸ“‹ Copiar pedido'; btn.classList.remove('copiado'); }, 2000);
      }).catch(() => mostrarToast('Erro ao copiar. Tente novamente.'));
    }

    // â”€â”€ HISTÃ“RICO DE MOVIMENTAÃ‡Ã•ES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function abrirHistorico(produto) {
      const overlay = document.getElementById('modal-overlay');
      const tbody   = document.getElementById('tbody-mov');
      document.getElementById('modal-titulo').textContent   = produto.nome;
      document.getElementById('modal-subtitulo').textContent = `Estoque atual: ${produto.estoque} un.`;
      tbody.innerHTML = `<tr><td colspan="4" class="modal-status">Carregando...</td></tr>`;
      overlay.classList.add('visivel');
      document.body.style.overflow = 'hidden';

      // Endpoint baseado no padrÃ£o da URL do sistema: /produtos/movimentacoes_estoque/{id}
      const endpoints = [
        `https://caixa-three.vercel.app/api/produtos/movimentacoes_estoque/${produto.id}?loja_id=${lojaIdJeta}`,
        `https://caixa-three.vercel.app/api/produtos/${produto.id}/movimentacoes_estoque?loja_id=${lojaIdJeta}`,
      ];

      let dados = null;
      for (const url of endpoints) {
        try {
          const res = await fetch(url);
          const json = await res.json();
          if (json.code === 200 || Array.isArray(json.data)) { dados = json; break; }
        } catch { /* tenta prÃ³ximo */ }
      }

      if (!dados || !dados.data || dados.data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="modal-status ${!dados ? 'erro' : ''}">
          ${!dados ? 'Endpoint de movimentaÃ§Ãµes nÃ£o encontrado.' : 'Nenhuma movimentaÃ§Ã£o registada.'}
        </td></tr>`;
        return;
      }

      tbody.innerHTML = '';
      dados.data.forEach(mov => {
        // Campos: tipo pode vir como 'tipo', 'tipo_movimentacao', 'descricao', 'origem'
        const tipo = (mov.tipo || mov.tipo_movimentacao || mov.descricao || mov.origem || '').toLowerCase();
        const qtd  = Math.abs(Number(mov.quantidade ?? mov.qtd ?? mov.valor ?? 0));
        const saldo = mov.saldo ?? mov.saldo_apos ?? mov.estoque_apos ?? mov.estoque ?? 'â€”';
        const data  = formatarData(mov.data || mov.criado_em || mov.cadastrado_em || mov.created_at || '');

        // Determina entrada ou saÃ­da pelo tipo ou pelo sinal da quantidade original
        const qtdRaw = Number(mov.quantidade ?? mov.qtd ?? 0);
        const isEntrada = tipo.includes('entr') || tipo.includes('compra') || tipo.includes('ajuste positivo') || qtdRaw > 0;
        const tipoLabel = isEntrada ? 'Entrada' : 'SaÃ­da';
        const tipoClass = isEntrada ? 'mov-entrada' : 'mov-saida';
        const sinal     = isEntrada ? '+' : 'âˆ’';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${data}</td>
          <td style="text-align:center;"><span class="${tipoClass}">${tipoLabel}</span></td>
          <td style="text-align:center;" class="${tipoClass}">${sinal}${qtd}</td>
          <td style="text-align:center;">${saldo}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function fecharModal() {
      document.getElementById('modal-overlay').classList.remove('visivel');
      document.body.style.overflow = '';
    }



    let toastTimer;
    function mostrarToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('visivel');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => t.classList.remove('visivel'), 2200);
    }

    // â”€â”€ EVENTOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    document.getElementById('btn-fechar-modal').addEventListener('click', fecharModal);
    document.getElementById('modal-overlay').addEventListener('click', (e) => {
      if (e.target === document.getElementById('modal-overlay')) fecharModal();
    });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') fecharModal(); });

    document.getElementById('btn-buscar').addEventListener('click', () => carregarProdutos(document.getElementById('campo-busca').value));
    document.getElementById('campo-busca').addEventListener('keypress', e => { if (e.key === 'Enter') document.getElementById('btn-buscar').click(); });
    document.getElementById('campo-filtro').addEventListener('input', filtrarTabela);
    document.getElementById('btn-copiar').addEventListener('click', copiarPedido);
    document.getElementById('btn-limpar').addEventListener('click', limparCarrinho);
    document.getElementById('btn-toggle-carrinho').addEventListener('click', toggleCarrinho);

    document.querySelectorAll('#tabela-produtos thead th[data-coluna]').forEach(header => {
      header.addEventListener('click', () => {
        const coluna = header.dataset.coluna;
        const ordem = header.dataset.ordem === 'asc' ? 'desc' : 'asc';
        document.querySelectorAll('#tabela-produtos thead th').forEach(th => th.className = '');
        header.dataset.ordem = ordem;
        header.classList.add(`ordenado-${ordem}`);
        ordenarTabela(coluna, ordem);
      });
    });

    atualizarCarrinho();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Produtos da Loja com Busca via API</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f7f9fc; color: #333; }
    h1 { text-align: center; margin-bottom: 20px; color: #004a99; font-size: 1.6rem; }
    #container-busca { max-width: 700px; margin: 0 auto 12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    #campo-busca { flex:1 1 220px; padding:10px 12px; border:2px solid #004a99; border-radius:6px; font-size:15px; }
    #btn-buscar { padding:10px 16px; background:#004a99; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    #btn-buscar:hover { background:#0066cc; }
    details { max-width:700px; margin: 10px auto; background:#e9f0fa; border:1px solid #004a99; border-radius:6px; padding:10px 14px; }
    summary { font-weight:600; cursor:pointer; }
    .checkbox-group label { display:flex; align-items:center; gap:8px; margin-top:8px; cursor:pointer; }
    .table-wrapper { max-width:700px; width:90%; margin: 14px auto; box-shadow:0 2px 8px rgba(0,0,0,0.08); border-radius:8px; overflow:hidden; }
    table { width:100%; border-collapse:collapse; background:white; }
    th, td { padding:10px; text-align:left; border-bottom:1px solid #eee; font-size:14px; }
    th { background:#004a99; color:#fff; }
    tbody tr:nth-child(odd){ background:#fafafa; }
    @media (max-width:600px){
      #container-busca { padding:0 12px; flex-direction:column; }
      #btn-buscar { width:100%; }
    }
  </style>
</head>
<body>
  <h1>Produtos da Loja</h1>

  <div id="container-busca">
    <input id="campo-busca" type="text" placeholder="Digite o nome do produto..." aria-label="Campo de busca" />
    <button id="btn-buscar" type="button">Buscar</button>
  </div>

  <details id="opcoes-avancadas">
    <summary>Opções avançadas</summary>
    <div class="checkbox-group" role="group" aria-label="Filtro de grupos">
      <label><input type="checkbox" name="grupo" value="todos" id="grupo-todos" checked /> Todos Grupos (padrão)</label>
      <!-- Substitua os IDs abaixo caso sejam diferentes -->
      <label><input type="checkbox" name="grupo" value="5372327" id="grupo-ativos" /> Ativos (ID 5372327)</label>
      <label><input type="checkbox" name="grupo" value="5372328" id="grupo-inativos" /> Inativos (ID 5372328)</label>
    </div>
  </details>

  <div class="table-wrapper">
    <table id="tabela-produtos" aria-label="Tabela de produtos">
      <thead>
        <tr><th>Nome</th><th>Estoque</th></tr>
      </thead>
      <tbody>
        <tr><td colspan="2" style="text-align:center;">Realize uma busca para listar produtos.</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    const lojaIdJeta = "361408"; // mantém a loja
    let todosProdutos = [];

    // Garante comportamento: se marcar "todos" limpa os outros; se marcar qualquer outro, desmarca "todos"
    const chkTodos = document.getElementById('grupo-todos');
    const chks = Array.from(document.querySelectorAll('input[name="grupo"]')).filter(c => c.id !== 'grupo-todos');

    chkTodos.addEventListener('change', () => {
      if (chkTodos.checked) chks.forEach(c => c.checked = false);
    });
    chks.forEach(ch => ch.addEventListener('change', () => {
      if (ch.checked) chkTodos.checked = false;
      // se nenhum marcado, reativa 'todos'
      const any = chks.some(c => c.checked);
      if (!any) chkTodos.checked = true;
    }));

    function getGruposSelecionados() {
      const checked = Array.from(document.querySelectorAll('input[name="grupo"]:checked')).map(c => c.value);
      // se "todos" está selecionado ou não houver seleção -> retorna empty (interpretação: sem filtro)
      if (checked.includes('todos') || checked.length === 0) return [];
      return checked; // array de IDs (strings)
    }

    async function buscarProdutos(nomeBusca = "", pagina = 1, grupos = []) {
      const url = new URL("https://caixa-three.vercel.app/api/produtos");
      url.searchParams.append("loja_id", lojaIdJeta);
      url.searchParams.append("pagina", pagina);
      if (nomeBusca && nomeBusca.trim()) url.searchParams.append("nome", nomeBusca.trim());
      if (grupos && grupos.length > 0) {
        // envia como comma-separated para o backend
        url.searchParams.append("grupo_id", grupos.join(','));
      }
      const resp = await fetch(url.toString());
      if (!resp.ok) throw new Error('Erro: ' + resp.status + ' ' + resp.statusText);
      return await resp.json();
    }

    function renderizarTabela(produtos) {
      const tbody = document.querySelector('#tabela-produtos tbody');
      if (!produtos || produtos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align:center;">Nenhum produto encontrado.</td></tr>';
        return;
      }
      tbody.innerHTML = '';
      produtos.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${p.nome}</td><td>${p.estoque}</td>`;
        tbody.appendChild(tr);
      });
    }

    async function carregarProdutos(nomeBusca = "") {
      const tbody = document.querySelector('#tabela-produtos tbody');
      tbody.innerHTML = '<tr><td colspan="2" style="text-align:center;">Carregando...</td></tr>';
      const grupos = getGruposSelecionados(); // array vazio => todos
      let pagina = 1;
      let totalPaginas = 1;
      todosProdutos = [];
      try {
        do {
          const dados = await buscarProdutos(nomeBusca, pagina, grupos);
          if (dados.code !== 200) throw new Error(dados.data?.mensagem || 'Erro ao buscar produtos');
          todosProdutos = todosProdutos.concat(dados.data);
          totalPaginas = dados.meta?.total_paginas || 1;
          pagina++;
        } while (pagina <= totalPaginas);
        // opcional: ordenar por nome
        todosProdutos.sort((a,b)=> (a.nome||'').localeCompare(b.nome||''));
        renderizarTabela(todosProdutos);
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="2" style="text-align:center;color:red;">${err.message}</td></tr>`;
      }
    }

    document.getElementById('btn-buscar').addEventListener('click', () => {
      const nome = document.getElementById('campo-busca').value;
      carregarProdutos(nome);
    });
    document.getElementById('campo-busca').addEventListener('keypress', e => {
      if (e.key === 'Enter') { e.preventDefault(); document.getElementById('btn-buscar').click(); }
    });
  </script>
</body>
</html>

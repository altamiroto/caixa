<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Produtos da Loja com Busca via API</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f7f9fc;
      color: #333;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #004a99;
      font-size: 1.8rem;
    }
    
    #container-busca, #container-filtro {
      max-width: 600px;
      margin: 0 auto 20px auto;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      padding: 0 10px;
    }
    
    #campo-busca, #campo-filtro {
      flex-grow: 1;
      padding: 10px 15px;
      font-size: 16px;
      border: 2px solid #004a99;
      border-radius: 6px;
      outline: none;
      transition: border-color 0.3s ease;
    }
    
    #btn-buscar {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #004a99;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .table-wrapper {
      max-width: 800px;
      width: 95%;
      margin: 0 auto;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      table-layout: fixed; /* Força o controle das larguras */
    }
    
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
      font-size: 14px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    th {
      background-color: #004a99;
      color: white;
      cursor: pointer;
      position: relative;
    }

    /* Ajuste de largura das colunas */
    th:nth-child(1), td:nth-child(1) { width: 50%; } /* Nome */
    th:nth-child(2), td:nth-child(2) { width: 15%; text-align: center; } /* Estoque */
    th:nth-child(3), td:nth-child(3) { width: 35%; text-align: center; } /* Última Movimentação */

    th.ordenado-asc::after { content: ' ▲'; font-size: 10px; }
    th.ordenado-desc::after { content: ' ▼'; font-size: 10px; }
    
    tbody tr:nth-child(odd) { background-color: #f2f2f2; }
    tr:hover { background-color: #e0eaf5; }

    .sem-registro {
      color: #999;
      font-style: italic;
      font-size: 12px;
    }

    @media (max-width: 600px) {
      #container-busca, #container-filtro { flex-direction: column; }
      th, td { white-space: normal; }
      th:nth-child(1), td:nth-child(1) { width: 40%; }
      th:nth-child(2), td:nth-child(2) { width: 20%; }
      th:nth-child(3), td:nth-child(3) { width: 40%; }
    }
  </style>
</head>
<body>

  <h1>Produtos da Loja</h1>

  <div id="container-busca">
    <input type="text" id="campo-busca" placeholder="Buscar produto..." />
    <button id="btn-buscar">Buscar</button>
  </div>
  
  <div id="container-filtro" style="display: none;">
    <input type="text" id="campo-filtro" placeholder="Filtrar nesta lista..." />
  </div>

  <div class="table-wrapper">
    <table id="tabela-produtos">
      <thead>
        <tr>
          <th data-coluna="nome" data-ordem="asc" class="ordenado-asc">Nome</th>
          <th data-coluna="estoque" data-ordem="asc">Estoque</th>
          <th data-coluna="modificado_em" data-ordem="asc">Última Movimentação</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="3" style="text-align:center; padding: 20px;">Faça uma busca para ver os produtos.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <script>
    const lojaIdJeta = "361408";
    let todosProdutos = [];
    let produtosFiltrados = [];

    function formatarData(dataString) {
      if (!dataString || dataString === "null" || dataString === "") {
        return '<span class="sem-registro">Sem registro</span>';
      }
      try {
        const partes = dataString.split(' ');
        const dataPartes = partes[0].split('-');
        if (dataPartes.length !== 3) return dataString;
        const dataBR = `${dataPartes[2]}/${dataPartes[1]}/${dataPartes[0]}`;
        const horaBR = partes[1] ? partes[1].substring(0, 5) : "";
        return horaBR ? `${dataBR} ${horaBR}` : dataBR;
      } catch (e) {
        return dataString;
      }
    }

    async function buscarProdutos(nomeBusca = "", pagina = 1) {
      const url = new URL("https://caixa-three.vercel.app/api/produtos"); 
      url.searchParams.append("loja_id", lojaIdJeta);
      url.searchParams.append("pagina", pagina);
      if (nomeBusca.trim() !== "") url.searchParams.append("nome", nomeBusca.trim());
      
      const resposta = await fetch(url.toString());
      return await resposta.json();
    }

    function renderizarTabela(produtos) {
      produtosFiltrados = produtos;
      const tbody = document.querySelector("#tabela-produtos tbody");
      if (!produtos || produtos.length === 0) {
        tbody.innerHTML = "<tr><td colspan='3' style='text-align:center;'>Nenhum produto encontrado.</td></tr>";
        return;
      }
      
      tbody.innerHTML = "";
      produtos.forEach(produto => {
        const linha = document.createElement("tr");
        const dataMov = produto.modificado_em || produto.cadastrado_em || "";
        linha.innerHTML = `
          <td>${produto.nome}</td>
          <td style="text-align: center;">${produto.estoque}</td>
          <td style="text-align: center;">${formatarData(dataMov)}</td>
        `;
        tbody.appendChild(linha);
      });
    }

    async function carregarProdutos(nomeBusca = "") {
      const tbody = document.querySelector("#tabela-produtos tbody");
      const filtroContainer = document.getElementById('container-filtro');
      tbody.innerHTML = "<tr><td colspan='3' style='text-align:center;'>Carregando...</td></tr>";
      filtroContainer.style.display = 'none';

      let pagina = 1;
      let totalPaginas = 1;
      todosProdutos = [];

      try {
        do {
          const dados = await buscarProdutos(nomeBusca, pagina);
          if (dados.code !== 200) throw new Error("Erro na API");
          const novos = dados.data.filter(p => p.nome);
          todosProdutos = todosProdutos.concat(novos);
          totalPaginas = dados.meta.total_paginas;
          pagina++;
        } while (pagina <= totalPaginas);

        todosProdutos.sort((a, b) => a.nome.localeCompare(b.nome));
        renderizarTabela(todosProdutos);
        filtroContainer.style.display = 'flex';
      } catch (error) {
        tbody.innerHTML = `<tr><td colspan='3' style='text-align:center; color:red;'>${error.message}</td></tr>`;
      }
    }

    function filtrarTabela() {
        const termo = document.getElementById('campo-filtro').value.toLowerCase().trim();
        const filtrados = todosProdutos.filter(p => p.nome.toLowerCase().includes(termo));
        renderizarTabela(filtrados);
    }

    function ordenarTabela(coluna, ordem) {
      if (produtosFiltrados.length === 0) return;
      const ordenados = [...produtosFiltrados].sort((a, b) => {
        let vA = a[coluna] || '';
        let vB = b[coluna] || '';
        if (coluna === 'estoque') {
          return ordem === 'asc' ? Number(vA) - Number(vB) : Number(vB) - Number(vA);
        }
        return ordem === 'asc' ? vA.toString().localeCompare(vB.toString()) : vB.toString().localeCompare(vA.toString());
      });
      renderizarTabela(ordenados);
    }
    
    document.getElementById("btn-buscar").addEventListener("click", () => carregarProdutos(document.getElementById("campo-busca").value));
    document.getElementById("campo-busca").addEventListener("keypress", (e) => { if (e.key === "Enter") document.getElementById("btn-buscar").click(); });
    document.getElementById("campo-filtro").addEventListener("input", filtrarTabela);

    document.querySelectorAll('#tabela-produtos thead th').forEach(header => {
      header.addEventListener('click', () => {
        const coluna = header.dataset.coluna;
        let ordem = header.dataset.ordem === 'asc' ? 'desc' : 'asc';
        document.querySelectorAll('#tabela-produtos thead th').forEach(th => th.className = '');
        header.dataset.ordem = ordem;
        header.classList.add(`ordenado-${ordem}`);
        ordenarTabela(coluna, ordem);
      });
    });
  </script>
</body>
</html>

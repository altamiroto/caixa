<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Parcelas Pro</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --accent-color: #FF9800;
            --danger-color: #f44336;
            --success-color: #4CAF50;
            --bg-primary: #f4f4f9;
            --bg-secondary: #fff;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #ddd;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-hover: 0 6px 20px rgba(0,0,0,0.15);
        }
        [data-theme="dark"] {
            --bg-primary: #1a1a1a; --bg-secondary: #2d2d2d;
            --text-primary: #e0e0e0; --text-secondary: #b0b0b0;
            --border-color: #444;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #e0e0e0 100%);
            color: var(--text-primary);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; padding: 20px; transition: all 0.3s ease;
        }
        .container {
            width: 100%; max-width: 700px;
            background-color: var(--bg-secondary);
            padding: 30px; border-radius: 20px;
            box-shadow: var(--shadow); transition: all 0.3s ease;
        }
        .header { text-align: center; margin-bottom: 30px; position: relative; }
        h1 {
            background: linear-gradient(135deg, #4CAF50 0%, #2196F3 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; font-size: 2rem; margin-bottom: 10px;
        }
        .theme-toggle {
            position: absolute; top: 0; right: 0;
            background: var(--border-color); border: none;
            padding: 8px 12px; border-radius: 20px; cursor: pointer;
            font-size: 1.2rem; transition: all 0.3s ease;
        }
        .theme-toggle:hover { transform: scale(1.1); }
        .quick-links { text-align: center; margin-bottom: 20px; font-size: 0.9rem; }
        .quick-links a { color: var(--secondary-color); text-decoration: none; margin: 0 10px; }
        .quick-links a:hover { color: var(--primary-color); text-decoration: underline; }
        .section-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 15px; padding: 20px; margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .section-card:hover { box-shadow: var(--shadow-hover); }
        .section-title { font-size: 1.1rem; color: var(--primary-color); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .input-group { margin-bottom: 20px; position: relative; }
        .input-with-icon { position: relative; }
        .input-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            color: var(--text-secondary); font-size: 1.2rem; pointer-events: none;
        }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary); font-size: 0.95rem; }
        label small { font-weight: normal; color: var(--text-secondary); font-size: 0.85rem; }
        input::placeholder { color: #999; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"], input[type="text"] {
            width: 100%; padding: 14px 14px 14px 42px; font-size: 16px;
            border: 2px solid var(--border-color); border-radius: 10px;
            background: var(--bg-secondary); color: var(--text-primary);
            -moz-appearance: textfield; transition: all 0.3s ease;
        }
        input[type="number"]:focus, input[type="text"]:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76,175,80,0.1);
        }
        input[type="number"].invalid { border-color: var(--danger-color); background-color: #fff5f5; }
        textarea {
            width: 100%; min-height: 120px; background-color: var(--bg-primary);
            padding: 12px; border: 2px solid var(--border-color); border-radius: 10px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px; color: var(--text-primary); resize: vertical; transition: all 0.3s ease;
        }
        textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(76,175,80,0.1); }
        textarea#resultado {
            background: linear-gradient(135deg, #f0f0f0 0%, #e8e8e8 100%);
            font-family: 'Courier New', monospace; font-size: 13px;
        }
        [data-theme="dark"] textarea#resultado { background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%); }
        .toggle-section {
            display: flex; align-items: center; gap: 10px; margin-bottom: 15px;
            padding: 15px; background: var(--bg-primary); border-radius: 10px;
            transition: all 0.3s ease; cursor: pointer; min-height: 54px;
        }
        .toggle-section:hover { background: var(--border-color); }
        .toggle-section input[type="checkbox"] { width: 22px; height: 22px; cursor: pointer; flex-shrink: 0; }
        .toggle-section label { margin: 0; cursor: pointer; flex: 1; user-select: none; font-size: 1rem; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out; }
        .collapsible-content.show { max-height: 5000px; transition: max-height 0.5s ease-in; }
        .option-group { border: 2px solid var(--border-color); padding: 15px; border-radius: 10px; margin-top: 15px; background: var(--bg-primary); }
        .option-group h4 { margin: 0 0 15px 0; color: var(--primary-color); display: flex; align-items: center; gap: 8px; }
        .parcelas-checkboxes { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
        .checkbox-item { display: flex; flex-direction: column; }
        .parcela-input-group { display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 8px; }
        .checkbox-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .checkbox-item label { margin: 0; font-weight: normal; cursor: pointer; flex: 1; }
        .percent-input-container { display: none; align-items: center; gap: 5px; }
        .percent-input-container.show { display: flex; }
        .percent-input-container input { width: 70px; padding: 6px 8px; font-size: 13px; }
        /* Mini-op√ß√µes parcela espec√≠fica */
        #parcelaEspecificaOpcoes { display: none; flex-direction: column; gap: 6px; margin-top: 10px; }
        #parcelaEspecificaOpcoes.show { display: flex; }
        .mini-opcao {
            display: flex; align-items: center; gap: 6px;
            background: var(--bg-primary); border: 2px solid var(--border-color);
            border-radius: 8px; padding: 7px 12px; cursor: pointer;
            transition: all 0.2s ease; user-select: none;
            font-size: 0.88rem; font-weight: 600; color: var(--text-secondary);
        }
        .mini-opcao:hover { border-color: var(--primary-color); background: rgba(76,175,80,0.07); }
        .mini-opcao input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; accent-color: var(--primary-color); flex-shrink: 0; }
        .mini-opcao.ativo { border-color: var(--primary-color); background: rgba(76,175,80,0.12); color: var(--primary-color); }
        .taxa-chip {
            display: inline-flex; align-items: center; gap: 5px;
            background: var(--bg-primary); border: 2px solid var(--border-color);
            border-radius: 8px; padding: 5px 10px; font-size: 0.85rem;
            font-weight: 600; color: var(--text-secondary); transition: border-color 0.2s;
        }
        .taxa-chip:focus-within { border-color: var(--secondary-color); }
        .taxa-chip span { white-space: nowrap; }
        .taxa-chip input[type="number"] {
            width: 58px; padding: 2px 5px; font-size: 13px;
            border: 1px solid var(--border-color); border-radius: 5px;
            background: var(--bg-secondary); color: var(--text-primary); text-align: right;
        }
        .taxa-chip input[type="number"]:focus { outline: none; border-color: var(--secondary-color); }
        .button-row {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px; margin-top: 15px;
        }
        .btn {
            padding: 14px 24px; font-size: 16px; font-weight: 600; border: none;
            border-radius: 10px; cursor: pointer; transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center; gap: 8px; min-height: 48px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); }
        .btn:active { transform: translateY(0); }
        .btn-primary { background: linear-gradient(135deg, var(--primary-color) 0%, #45a049 100%); color: white; }
        .btn-secondary { background: linear-gradient(135deg, var(--secondary-color) 0%, #1976D2 100%); color: white; }
        .btn-accent { background: linear-gradient(135deg, var(--accent-color) 0%, #F57C00 100%); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--border-color); color: var(--text-primary); }
        .btn-outline:hover { background: var(--border-color); }
        .btn-danger { background: linear-gradient(135deg, var(--danger-color) 0%, #d32f2f 100%); color: white; }
        .copy-message {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724; padding: 15px; border-radius: 10px; font-size: 14px;
            opacity: 0; transition: opacity 0.5s ease; text-align: center; margin-top: 10px;
        }
        .copy-message.show { opacity: 1; }
        .discount-summary {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
            border-left: 4px solid var(--accent-color); padding: 15px;
            border-radius: 10px; margin: 15px 0; display: none;
        }
        [data-theme="dark"] .discount-summary { background: linear-gradient(135deg, #3d3520 0%, #2d2614 100%); }
        .discount-summary.active { display: block; animation: slideIn 0.3s ease; }
        .discount-summary h4 { color: var(--accent-color); margin-bottom: 10px; }
        .error-message {
            color: #d9534f; background: linear-gradient(135deg, #f2dede 0%, #ebcccc 100%);
            padding: 15px; border-radius: 10px; margin-top: 10px; border-left: 4px solid #d9534f;
        }
        /* Tabela de produtos */
        #productListResult table {
            width: 100%; border-collapse: collapse; margin-top: 15px;
            border-radius: 10px; overflow: hidden; table-layout: fixed;
        }
        #productListResult th, #productListResult td {
            border: 1px solid var(--border-color); padding: 10px; text-align: center;
            word-break: break-word; overflow-wrap: break-word;
        }
        #productListResult th {
            background: linear-gradient(135deg, var(--primary-color) 0%, #45a049 100%);
            color: white; font-weight: 600;
        }
        #productListResult tr:hover { background: var(--bg-primary); }
        #productListResult a { color: var(--secondary-color); text-decoration: none; font-weight: 600; }
        #productListResult a:hover { color: var(--primary-color); text-decoration: underline; }
        #productListResult th:nth-child(1), #productListResult td:nth-child(1) { width: 36px; padding: 8px 4px; }
        #productListResult th:nth-child(3), #productListResult td:nth-child(3) { width: 90px; font-size: 0.85rem; white-space: nowrap; }
        #productListResult td:nth-child(2) { text-align: left; font-size: 0.88rem; }
        /* Coluna ajuste */
        .col-adj { width: 34px; padding: 6px 3px !important; overflow: hidden; }
        /* Painel de ajuste por produto */
        .product-adj-row td { padding: 0 !important; border-top: none !important; background: transparent !important; }
        .product-adj-row:hover { background: transparent !important; }
        .adj-panel {
            display: none;
            background: linear-gradient(135deg, rgba(33,150,243,0.05) 0%, rgba(76,175,80,0.05) 100%);
            border: 2px dashed var(--secondary-color);
            border-radius: 10px; margin: 4px 6px 8px 6px; padding: 12px 14px;
            animation: slideDown 0.25s ease;
        }
        .adj-panel.open { display: block; }
        @keyframes slideDown { from { opacity:0; transform:translateY(-8px); } to { opacity:1; transform:translateY(0); } }
        .adj-panel-title {
            font-size: 0.78rem; font-weight: 700; color: var(--secondary-color);
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .adj-fields { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; }
        .adj-field { display: flex; flex-direction: column; gap: 3px; }
        .adj-field label { font-size: 0.72rem; font-weight: 600; color: var(--text-secondary); margin: 0; text-transform: uppercase; letter-spacing: 0.3px; }
        .adj-field-inner {
            display: flex; align-items: center; gap: 4px;
            background: var(--bg-secondary); border: 1.5px solid var(--border-color);
            border-radius: 7px; padding: 5px 8px; transition: border-color 0.2s;
        }
        .adj-field-inner:focus-within { border-color: var(--secondary-color); }
        .adj-field-inner span { font-size: 0.78rem; color: var(--text-secondary); white-space: nowrap; }
        .adj-field-inner input {
            width: 100%; padding: 0 !important; font-size: 13px; border: none !important;
            background: transparent !important; color: var(--text-primary); outline: none;
            -moz-appearance: textfield; box-shadow: none !important;
        }
        .adj-field-inner input::-webkit-outer-spin-button,
        .adj-field-inner input::-webkit-inner-spin-button { -webkit-appearance: none; }
        .adj-comment-row { margin-top: 10px; display: flex; flex-direction: column; gap: 3px; }
        .adj-comment-row label { font-size: 0.72rem; font-weight: 600; color: var(--text-secondary); margin: 0; text-transform: uppercase; letter-spacing: 0.3px; }
        .adj-comment-input {
            width: 100%; padding: 7px 10px !important; font-size: 13px;
            border: 1.5px solid var(--border-color) !important; border-radius: 7px;
            background: var(--bg-secondary) !important; color: var(--text-primary);
            resize: none; min-height: 56px; font-family: inherit; transition: border-color 0.2s; outline: none;
        }
        .adj-comment-input:focus { border-color: var(--secondary-color) !important; }
        .adj-comment-input::placeholder { color: #999; font-style: italic; }
        .adj-reset {
            background: none; border: none; color: var(--danger-color);
            cursor: pointer; font-size: 0.78rem; font-weight: 600;
            padding: 2px 6px; border-radius: 5px; transition: background 0.2s;
        }
        .adj-reset:hover { background: rgba(244,67,54,0.1); }
        .btn-adj {
            background: none; border: 1.5px solid var(--border-color);
            color: var(--text-secondary); border-radius: 7px;
            cursor: pointer; padding: 3px 5px; font-size: 0.85rem;
            transition: all 0.2s ease; line-height: 1;
            max-width: 100%; display: inline-flex; align-items: center; justify-content: center;
        }
        .btn-adj:hover { border-color: var(--secondary-color); color: var(--secondary-color); transform: scale(1.1); }
        .btn-adj.active { border-color: var(--secondary-color); background: rgba(33,150,243,0.12); color: var(--secondary-color); }
        .btn-adj.has-adj { border-color: var(--accent-color); color: var(--accent-color); }
        .btn-adj.has-adj.active { background: rgba(255,152,0,0.12); }
        .adj-badge {
            display: inline-block; background: var(--accent-color); color: white;
            font-size: 0.65rem; font-weight: 700; padding: 1px 5px;
            border-radius: 4px; margin-left: 5px; vertical-align: middle;
            text-transform: uppercase; letter-spacing: 0.3px;
        }
        .comment-badge {
            display: inline-block; background: var(--secondary-color); color: white;
            font-size: 0.65rem; font-weight: 700; padding: 1px 5px;
            border-radius: 4px; margin-left: 4px; vertical-align: middle;
        }
        /* Toggle ajuste individual */
        .per-product-toggle {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 14px; background: var(--bg-primary);
            border: 2px solid var(--border-color); border-radius: 10px;
            cursor: pointer; transition: all 0.2s; margin-top: 15px;
            user-select: none;
        }
        .per-product-toggle:hover { border-color: var(--secondary-color); background: rgba(33,150,243,0.05); }
        .per-product-toggle.enabled { border-color: var(--secondary-color); background: rgba(33,150,243,0.08); }
        .per-product-toggle input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--secondary-color); flex-shrink: 0; }
        .per-product-toggle label { margin: 0; cursor: pointer; font-size: 0.92rem; font-weight: 600; color: var(--text-secondary); }
        .per-product-toggle.enabled label { color: var(--secondary-color); }
        /* Loading */
        .loading-spinner { text-align: center; padding: 20px; display: none; }
        .loading-spinner.active { display: block; }
        .spinner {
            border: 4px solid var(--border-color); border-top: 4px solid var(--primary-color);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 0 auto;
        }
        @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
        hr { border:0; height:2px; background:var(--border-color); margin:20px 0; }
        .tooltip { position:relative; display:inline-block; cursor:help; }
        .tooltip:hover::after {
            content: attr(data-tooltip); position:absolute; bottom:125%; left:50%;
            transform:translateX(-50%); background:#333; color:white;
            padding:8px 12px; border-radius:8px; font-size:0.85rem; white-space:nowrap; z-index:1000;
        }
        input[type="number"]:not(:placeholder-shown), input[type="text"]:not(:placeholder-shown) {
            border-color: var(--success-color); background: rgba(76,175,80,0.05);
        }
        .adj-field-inner input:not(:placeholder-shown) {
            border-color: transparent !important; background: transparent !important;
        }
        @keyframes slideIn { from{opacity:0;transform:translateY(-10px);} to{opacity:1;transform:translateY(0);} }
        .product-count-badge {
            background: var(--secondary-color); color: white; padding: 4px 10px;
            border-radius: 12px; font-size: 0.85rem; font-weight: 600; margin-left: 8px;
        }
        /* Hist√≥rico */
        .historico-item { background:var(--bg-primary); border:2px solid var(--border-color); border-radius:10px; padding:15px; margin-bottom:15px; transition:all 0.3s ease; }
        .historico-item:hover { box-shadow:var(--shadow-hover); border-color:var(--primary-color); }
        .historico-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .historico-titulo { font-weight:600; font-size:1.1rem; color:var(--primary-color); }
        .historico-data { font-size:0.85rem; color:var(--text-secondary); }
        .historico-comentarios { background:var(--bg-secondary); padding:10px; border-radius:8px; margin:10px 0; font-size:0.9rem; color:var(--text-secondary); font-style:italic; }
        .historico-dados { background:var(--bg-secondary); padding:10px; border-radius:8px; font-size:0.85rem; margin-top:10px; }
        .historico-dados strong { color:var(--primary-color); }
        .historico-acoes { display:flex; gap:8px; margin-top:10px; }
        .historico-acoes button { flex:1; padding:8px 12px; font-size:0.85rem; }
        .empty-historico { text-align:center; padding:40px 20px; color:var(--text-secondary); }
        .empty-historico-icon { font-size:3rem; margin-bottom:10px; }
        .fab-historico {
            position:fixed; bottom:20px; right:20px; width:60px; height:60px;
            border-radius:50%; background:linear-gradient(135deg,var(--secondary-color) 0%,#1976D2 100%);
            color:white; border:none; font-size:1.5rem; cursor:pointer;
            box-shadow:0 4px 12px rgba(33,150,243,0.4); transition:all 0.3s ease;
            z-index:1000; display:flex; align-items:center; justify-content:center;
        }
        .fab-historico:hover { transform:scale(1.1); box-shadow:0 6px 20px rgba(33,150,243,0.6); }
        .fab-historico:active { transform:scale(0.95); }
        .fab-badge {
            position:absolute; top:-5px; right:-5px; background:var(--danger-color);
            color:white; border-radius:50%; width:24px; height:24px;
            font-size:0.75rem; font-weight:600; display:flex; align-items:center;
            justify-content:center; border:2px solid var(--bg-secondary);
        }
        @media (max-width:600px) {
            .container { padding:20px; }
            h1 { font-size:1.5rem; }
            .parcelas-checkboxes { grid-template-columns:1fr; }
            .button-row { grid-template-columns:1fr; }
            .theme-toggle { position:static; margin-top:10px; }
            .historico-header { flex-direction:column; align-items:flex-start; gap:5px; }
            input[type="number"],input[type="text"] { font-size:16px; }
            textarea { font-size:16px; }
            .btn { padding:16px 20px; min-height:52px; }
            .historico-acoes { flex-direction:column; }
            .historico-acoes button { width:100%; }
            .section-card { padding:15px; }
            #parcelaEspecificaOpcoes { flex-direction:column; }
            .adj-fields { grid-template-columns:1fr 1fr; }
            #productListResult th,#productListResult td { padding:7px 5px; font-size:0.78rem; }
            #productListResult th:nth-child(3),#productListResult td:nth-child(3) { width:80px; font-size:0.75rem; }
            .col-adj { width:28px !important; padding:4px 2px !important; }
            .btn-adj { padding:2px 3px; font-size:0.72rem; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üí∞ Calculadora de Parcelas Pro</h1>
        <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">üåì</button>
    </div>
    <div class="quick-links">
        <a href="https://calculadoracaixa.netlify.app/listas/" target="_blank">üìã Processamento de Lista</a>
        | <a href="https://calculadoracaixa.netlify.app/gestaoclick/" target="_blank">üì¶ Estoque</a>
    </div>

    <div class="toggle-section">
        <input type="checkbox" id="toggleProductList" onchange="toggleProductListSection()">
        <label for="toggleProductList">üì¶ Usar lista de produtos</label>
    </div>
    <div id="productListSection" class="collapsible-content">
        <div class="section-card">
            <div class="input-group">
                <label for="productList">Cole a lista de produtos:</label>
                <textarea id="productList" placeholder="Ex:&#10;iPhone 13 R$ 3.500,00&#10;Capa silicone R$ 50,00&#10;Fone Bluetooth R$ 150,00"></textarea>
            </div>
            <div class="button-row">
                <button class="btn btn-secondary" onclick="processList()">üìä Processar Lista</button>
                <button class="btn btn-accent" onclick="processWithAI()">‚ú® Processar com IA</button>
            </div>
            <div id="productListLoading" class="loading-spinner"><div class="spinner"></div><p>Processando...</p></div>
            <div id="productListResult"></div>
        </div>
    </div>

    <div class="section-card">
        <div class="section-title">üíµ Valores Principais</div>
        <div class="input-group">
            <label for="valorBase">Valor Base (R$):</label>
            <div class="input-with-icon"><span class="input-icon">üí≤</span>
            <input type="number" id="valorBase" placeholder="Ex: 500.00" step="0.01"></div>
        </div>
        <div class="input-group" style="margin-bottom:0">
            <label for="parcelaEspecifica">Parcelas <small>(opcional ‚Äî ex: 6 ou 3,6,12)</small>:</label>
            <div class="input-with-icon"><span class="input-icon">üî¢</span>
            <input type="text" id="parcelaEspecifica" placeholder="Ex: 6  ou  3,6,12" inputmode="numeric"></div>
            <div id="parcelaEspecificaOpcoes">
                <div id="parcelaChipsRow" style="display:flex;flex-wrap:wrap;gap:8px;width:100%">
                    <label class="mini-opcao" id="labelEspecificaPix">
                        <input type="checkbox" id="especificaMostrarPix" checked onchange="onQuickPixChange()"> üí∏ Dinheiro/Pix
                    </label>
                    <label class="mini-opcao" id="labelEspecificaTotal">
                        <input type="checkbox" id="especificaMostrarTotal" onchange="onQuickTotalChange()"> üßæ Total
                    </label>
                </div>
                <div id="parcelaTaxasRow" style="display:flex;flex-wrap:wrap;gap:8px;width:100%;margin-top:4px"></div>
            </div>
        </div>
    </div>

    <div class="section-card">
        <div class="section-title">üéÅ Acr√©scimos e Descontos</div>
        <div class="input-group">
            <label for="lucroAdicional">Acr√©scimo/Lucro (R$) <small>(aplicado ao valor final)</small></label>
            <div class="input-with-icon"><span class="input-icon">üí∞</span>
            <input type="number" id="lucroAdicional" placeholder="Ex: 50.00" step="0.01"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div class="input-group">
                <label for="descontoFixo">Desconto em R$ <small>(antes dos juros)</small>:</label>
                <div class="input-with-icon"><span class="input-icon">üí∏</span>
                <input type="number" id="descontoFixo" placeholder="Ex: 50.00" step="0.01" min="0"></div>
            </div>
            <div class="input-group">
                <label for="descontoPercentual">Desconto em % <small>(antes dos juros)</small></label>
                <div class="input-with-icon"><span class="input-icon">üìâ</span>
                <input type="number" id="descontoPercentual" placeholder="Ex: 10" step="0.01" min="0" max="100"></div>
            </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div class="input-group">
                <label for="acrescimoComissao">Comiss√£o (R$) <small>(acr√©scimo fixo)</small>:</label>
                <div class="input-with-icon"><span class="input-icon">ü§ù</span>
                <input type="number" id="acrescimoComissao" placeholder="Ex: 30.00" step="0.01" min="0"></div>
            </div>
            <div class="input-group">
                <label for="acrescimoPercentual">Acr√©scimo % <small>(sobre o valor base)</small></label>
                <div class="input-with-icon"><span class="input-icon">üìà</span>
                <input type="number" id="acrescimoPercentual" placeholder="Ex: 5" step="0.01" min="0"></div>
            </div>
        </div>
        <div class="input-group">
            <label for="valorEntrada">Valor da Entrada (R$):</label>
            <div class="input-with-icon"><span class="input-icon">üè¶</span>
            <input type="number" id="valorEntrada" placeholder="Ex: 100.00" step="0.01" min="0"></div>
        </div>
        <!-- Ajuste individual -->
        <label class="per-product-toggle" id="perProductToggleLabel" for="perProductAdjust">
            <input type="checkbox" id="perProductAdjust" onchange="onPerProductAdjustChange()">
            <label for="perProductAdjust">‚öôÔ∏è Ajuste individual por produto</label>
            <small style="margin-left:auto;font-size:0.78rem;font-weight:400;color:inherit;opacity:0.8">Ativa campos na tabela</small>
        </label>
        <div id="discountSummary" class="discount-summary">
            <h4>üìä Resumo de C√°lculos</h4>
            <p id="discountDetails"></p>
        </div>
    </div>

    <div class="toggle-section">
        <input type="checkbox" id="toggleAdvancedOptions" onchange="toggleAdvancedSection()">
        <label for="toggleAdvancedOptions">‚öôÔ∏è Op√ß√µes Avan√ßadas</label>
    </div>
    <div id="advancedOptions" class="collapsible-content">
        <div class="section-card">
            <div class="option-group">
                <h4>ü§ñ Configura√ß√£o da IA (Groq)</h4>
                <div class="input-group">
                    <textarea id="aiPrompt" style="height:120px">Voc√™ √© um assistente que extrai produtos e pre√ßos de textos bagun√ßados. 
Sua sa√≠da deve ser APENAS uma lista no formato: Nome do Produto R$ Valor.
Exemplo: 
iPhone 13 R$ 3.500,00
Capa silicone R$ 50,00

- Caso tenha informa√ß√µes adicionais do produto colocar entre par√™nteses, ap√≥s o nome do produto, no formato (informa√ß√£o 1/informa√ß√£o 2, etc)
- A saida deve ter a virgula como casa de separa√ß√£o de centavos
- N√£o escreva introdu√ß√µes nem conclus√µes.</textarea>
                </div>
            </div>
            <hr>
            <div class="option-group">
                <h4>‚ú® Emoticons nos Valores</h4>
                <div class="checkbox-item">
                    <div class="parcela-input-group">
                        <input type="checkbox" id="useEmoticons" onchange="calcularParcelas()">
                        <label for="useEmoticons">Ativar emoticons no texto de sa√≠da</label>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
                    <div class="input-group">
                        <label for="emoticonDinheiro">Dinheiro:</label>
                        <input type="text" id="emoticonDinheiro" value="üí∏ " placeholder="Ex: üí∏">
                        <small>Sugest√µes: üí∏ üíµ üí∞ ü§ë</small>
                    </div>
                    <div class="input-group">
                        <label for="emoticonCartao">Cart√£o:</label>
                        <input type="text" id="emoticonCartao" value="üí≥ " placeholder="Ex: üí≥">
                        <small>Sugest√µes: üí≥ üèß ü™™ üõí</small>
                    </div>
                </div>
            </div>
            <hr>
            <div class="option-group">
                <h4>üéØ Arredondamento de Valores</h4>
                <div class="input-group">
                    <label for="fatorArredondamento">Fator de arredondamento:</label>
                    <div class="input-with-icon"><span class="input-icon">üîÑ</span>
                    <input type="number" id="fatorArredondamento" placeholder="Ex: 0.5, 0.2, 1" step="0.01" value="1" min="0.01"></div>
                    <small style="color:var(--text-secondary);margin-top:5px;display:block">
                        üí° Exemplos: 1 = inteiro (5,51‚Üí6) | 0,5 = meio | 0,2 = 20 centavos
                    </small>
                </div>
            </div>
            <hr>
            <div class="option-group">
                <h4>Á¶Å Personalizar Texto de Sa√≠da</h4>
                <div class="checkbox-item"><div class="parcela-input-group">
                    <input type="checkbox" id="hideDinheiroPix">
                    <label for="hideDinheiroPix">N√£o mostrar "Dinheiro/Pix"</label>
                    <div class="percent-input-container" id="porcentagemPixContainer">
                        <input type="number" id="porcentagemPix" placeholder="%" step="0.01" value="0"><span>%</span>
                    </div>
                </div></div>
                <div class="checkbox-item"><div class="parcela-input-group">
                    <input type="checkbox" id="showDebito">
                    <label for="showDebito">Mostrar "D√©bito"</label>
                    <div class="percent-input-container" id="porcentagemDebitoContainer">
                        <input type="number" id="porcentagemDebito" placeholder="%" step="0.01" value="2.5"><span>%</span>
                    </div>
                </div></div>
                <div class="checkbox-item"><div class="parcela-input-group">
                    <input type="checkbox" id="showComparison">
                    <label for="showComparison">Mostrar compara√ß√£o (economia vs sem desconto)</label>
                </div></div>
                <div class="checkbox-item"><div class="parcela-input-group">
                    <input type="checkbox" id="hideEntradaText">
                    <label for="hideEntradaText">N√£o mostrar "Entrada"</label>
                </div></div>
                <div class="checkbox-item"><div class="parcela-input-group">
                    <input type="checkbox" id="showTotalValue">
                    <label for="showTotalValue">Mostrar valor total (R$ XXXX)</label>
                </div></div>
                <div class="checkbox-item"><div class="parcela-input-group">
                    <input type="checkbox" id="boldProductName" checked>
                    <label for="boldProductName">Nome do produto em negrito (*texto*)</label>
                </div></div>
            </div>
            <hr>
            <div class="option-group">
                <h4>‚úèÔ∏è Textos Personalizados</h4>
                <div class="input-group">
                    <label for="produtoPrefix">Prefixo do produto:</label>
                    <input type="text" id="produtoPrefix" placeholder="Ex: üì¶, ‚û°Ô∏è, ‚ú®" value="‚û°Ô∏è ">
                    <small style="color:var(--text-secondary);margin-top:5px;display:block">Sugest√µes: üì± üçè üì∫ üíª ‚ú≥Ô∏è üì¶ üîå ‚ú® üéÅ</small>
                </div>
                <div class="input-group">
                    <label for="textoAdicionalLinha">Texto adicional por linha:</label>
                    <input type="text" id="textoAdicionalLinha" placeholder="Ex: 'sem juros no cart√£o'">
                </div>
                <div class="input-group">
                    <label for="textoCabecalhoMensagem">Mensagem de cabe√ßalho:</label>
                    <textarea id="textoCabecalhoMensagem" placeholder="Ex: 'Ol√°! Segue as condi√ß√µes de pagamento:'"></textarea>
                </div>
                <div class="input-group">
                    <label for="textoFinalMensagem">Texto final da mensagem:</label>
                    <textarea id="textoFinalMensagem" placeholder="Ex: 'Entre em contato para mais informa√ß√µes! üì±'"></textarea>
                </div>
            </div>
            <hr>
            <div class="option-group">
                <h4>üéØ Selecionar Parcelas e Taxa %</h4>
                <div class="parcelas-checkboxes" id="parcelasAvancadas"></div>
                <div class="button-row">
                    <button type="button" class="btn btn-outline" id="selectAll">‚úÖ Marcar Todas</button>
                    <button type="button" class="btn btn-outline" id="deselectAll">‚ùå Desmarcar Todas</button>
                </div>
            </div>
        </div>
    </div>

    <div class="section-card">
        <div class="section-title">üìã Resultado</div>
        <div class="input-group">
            <textarea id="resultado" readonly placeholder="Os valores de parcelamento aparecer√£o aqui..."></textarea>
        </div>
        <div class="button-row">
            <button type="button" class="btn btn-primary" onclick="copiarTexto()">üìã Copiar Texto</button>
            <button type="button" class="btn btn-outline" onclick="limparCampos()">üóëÔ∏è Limpar Tudo</button>
        </div>
        <div id="mensagemCopiado" class="copy-message">‚úÖ Texto copiado para √°rea de transfer√™ncia!</div>
    </div>

    <div class="toggle-section">
        <input type="checkbox" id="toggleHistorico" onchange="toggleHistoricoSection()">
        <label for="toggleHistorico">üìö Salvar no Hist√≥rico</label>
    </div>
    <div id="historicoSection" class="collapsible-content">
        <div class="section-card">
            <div class="input-group">
                <label for="historicoTitulo">T√≠tulo do c√°lculo:</label>
                <div class="input-with-icon"><span class="input-icon">üìù</span>
                <input type="text" id="historicoTitulo" placeholder="Ex: Venda iPhone 13"></div>
            </div>
            <div class="input-group">
                <label for="historicoComentarios">Coment√°rios (opcional):</label>
                <textarea id="historicoComentarios" placeholder="Observa√ß√µes sobre este c√°lculo..." style="min-height:80px"></textarea>
            </div>
            <!-- Toggle Sheets -->
            <label class="per-product-toggle" id="sheetsToggleLabel" for="toggleSheets" style="margin-bottom:15px">
                <input type="checkbox" id="toggleSheets" onchange="onSheetsToggleChange()">
                <label for="toggleSheets">‚òÅÔ∏è Sincronizar com Google Sheets</label>
                <small style="margin-left:auto;font-size:0.78rem;font-weight:400;color:inherit;opacity:0.8">Padr√£o: armazenamento local</small>
            </label>
            <div class="button-row">
                <button class="btn btn-primary" onclick="salvarNoHistorico()">üíæ Salvar Agora</button>
                <button class="btn btn-secondary" onclick="toggleVerHistorico()">üìã Ver Hist√≥rico</button>
            </div>
        </div>
    </div>

    <div id="visualizarHistoricoSection" class="collapsible-content">
        <div class="section-card">
            <div class="section-title">
                üìñ Hist√≥rico de C√°lculos
                <span id="historicoFonte" style="font-size:0.75rem;font-weight:400;color:var(--text-secondary);margin-left:8px">üíæ Local</span>
            </div>
            <div id="historicoLista"></div>
            <div class="button-row" style="margin-top:15px">
                <button class="btn btn-outline" onclick="toggleVerHistorico()">‚¨ÖÔ∏è Voltar</button>
                <button class="btn btn-danger" id="btnLimparHistorico" onclick="limparHistoricoCompleto()">üóëÔ∏è Limpar Hist√≥rico</button>
            </div>
        </div>
    </div>
</div>

<button class="fab-historico" onclick="abrirHistoricoRapido()" title="Ver hist√≥rico">
    üìö <span class="fab-badge" id="fabBadge" style="display:none">0</span>
</button>

<script>
// ‚îÄ‚îÄ Constantes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SHEETS_URL = 'https://script.google.com/macros/s/AKfycbwSXYcTYjsW4SjHf6s7zgD_0gjxnLfq23fPTsERsVNI2DTU2Nq81XZe34WlhvGiq2tI/exec';
const taxasDeJurosPadrao = {
    'pix':0, 1:0.045, 2:0.06, 3:0.07, 4:0.075, 5:0.08, 6:0.09,
    7:0.095, 8:0.10, 9:0.105, 10:0.115, 11:0.12, 12:0.125,
    13:0.135, 14:0.145, 15:0.15, 16:0.155, 17:0.16, 18:0.17, 'debito':0.025
};
const parcelasPadrao = [3, 6, 10, 12];

// ‚îÄ‚îÄ Estado ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let taxasRapidas = {};
let products = [];
let selectedProducts = [];
let productAdjustments = {};
let _sheetsCache = [];

// ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const valorBaseInput               = document.getElementById('valorBase');
const parcelaEspecificaInput       = document.getElementById('parcelaEspecifica');
const descontoPercentualInput      = document.getElementById('descontoPercentual');
const descontoFixoInput            = document.getElementById('descontoFixo');
const lucroAdicionalInput          = document.getElementById('lucroAdicional');
const acrescimoComissaoInput       = document.getElementById('acrescimoComissao');
const acrescimoPercentualInput     = document.getElementById('acrescimoPercentual');
const valorEntradaInput            = document.getElementById('valorEntrada');
const resultadoTextarea            = document.getElementById('resultado');
const mensagemCopiado              = document.getElementById('mensagemCopiado');
const discountSummary              = document.getElementById('discountSummary');
const discountDetails              = document.getElementById('discountDetails');
const toggleAdvancedOptions        = document.getElementById('toggleAdvancedOptions');
const advancedOptionsDiv           = document.getElementById('advancedOptions');
const hideDinheiroPixCheckbox      = document.getElementById('hideDinheiroPix');
const showDebitoCheckbox           = document.getElementById('showDebito');
const showComparisonCheckbox       = document.getElementById('showComparison');
const hideEntradaTextCheckbox      = document.getElementById('hideEntradaText');
const showTotalValueCheckbox       = document.getElementById('showTotalValue');
const boldProductNameCheckbox      = document.getElementById('boldProductName');
const textoAdicionalLinhaInput     = document.getElementById('textoAdicionalLinha');
const produtoPrefixInput           = document.getElementById('produtoPrefix');
const textoFinalMensagemTextarea   = document.getElementById('textoFinalMensagem');
const parcelasAvancadasDiv         = document.getElementById('parcelasAvancadas');
const selectAllButton              = document.getElementById('selectAll');
const deselectAllButton            = document.getElementById('deselectAll');
const textoCabecalhoMensagemTA     = document.getElementById('textoCabecalhoMensagem');
const fatorArredondamentoInput     = document.getElementById('fatorArredondamento');
const porcentagemPixInput          = document.getElementById('porcentagemPix');
const porcentagemDebitoInput       = document.getElementById('porcentagemDebito');
const porcentagemPixContainer      = document.getElementById('porcentagemPixContainer');
const porcentagemDebitoContainer   = document.getElementById('porcentagemDebitoContainer');
const toggleProductList            = document.getElementById('toggleProductList');
const productListSection           = document.getElementById('productListSection');
const productListTextarea          = document.getElementById('productList');
const productListLoading           = document.getElementById('productListLoading');
const productListResult            = document.getElementById('productListResult');
const aiPromptTextarea             = document.getElementById('aiPrompt');
const useEmoticonsCheckbox         = document.getElementById('useEmoticons');
const emoticonDinheiroInput        = document.getElementById('emoticonDinheiro');
const emoticonCartaoInput          = document.getElementById('emoticonCartao');
const toggleHistorico              = document.getElementById('toggleHistorico');
const historicoSection             = document.getElementById('historicoSection');
const historicoTituloInput         = document.getElementById('historicoTitulo');
const historicoComentariosTA       = document.getElementById('historicoComentarios');
const visualizarHistoricoSection   = document.getElementById('visualizarHistoricoSection');
const historicoLista               = document.getElementById('historicoLista');
const parcelaEspecificaOpcoes      = document.getElementById('parcelaEspecificaOpcoes');
const especificaMostrarPixCb       = document.getElementById('especificaMostrarPix');
const especificaMostrarTotalCb     = document.getElementById('especificaMostrarTotal');
const parcelaTaxasRow              = document.getElementById('parcelaTaxasRow');
const perProductAdjustCb           = document.getElementById('perProductAdjust');
const perProductToggleLabel        = document.getElementById('perProductToggleLabel');
const sheetsToggleLabel            = document.getElementById('sheetsToggleLabel');

// ‚îÄ‚îÄ Tema ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleTheme() {
    const t = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.body.setAttribute('data-theme', t);
    localStorage.setItem('theme', t);
}
const savedTheme = localStorage.getItem('theme');
if (savedTheme) document.body.setAttribute('data-theme', savedTheme);

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(msg) {
    mensagemCopiado.textContent = msg;
    mensagemCopiado.classList.add('show');
    setTimeout(() => {
        mensagemCopiado.classList.remove('show');
        mensagemCopiado.textContent = '‚úÖ Texto copiado para √°rea de transfer√™ncia!';
    }, 2500);
}

// ‚îÄ‚îÄ Chips parcelas r√°pidas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getParcelas() {
    const raw = parcelaEspecificaInput.value.trim();
    if (!raw) return [];
    return raw.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n) && n >= 1 && n <= 18);
}
function syncChipPix(checked) {
    especificaMostrarPixCb.checked = checked;
    document.getElementById('labelEspecificaPix').classList.toggle('ativo', checked);
    hideDinheiroPixCheckbox.checked = !checked;
    toggleDebitoPixPorcentagemInputs();
}
function syncChipTotal(checked) {
    especificaMostrarTotalCb.checked = checked;
    document.getElementById('labelEspecificaTotal').classList.toggle('ativo', checked);
    showTotalValueCheckbox.checked = checked;
}
function onQuickPixChange()   { syncChipPix(especificaMostrarPixCb.checked);    calcularParcelas(); }
function onQuickTotalChange() { syncChipTotal(especificaMostrarTotalCb.checked); calcularParcelas(); }

function gerarChipsTaxa(parcelas) {
    parcelaTaxasRow.innerHTML = '';
    parcelas.forEach(n => {
        const taxaPadrao = ((taxasDeJurosPadrao[n] || 0) * 100).toFixed(2);
        const valorAtual = taxasRapidas[n] !== undefined ? taxasRapidas[n] : taxaPadrao;
        const chip = document.createElement('div');
        chip.className = 'taxa-chip';
        chip.innerHTML = '<span>' + n + 'x</span><input type="number" step="0.01" min="0" value="' + valorAtual + '" data-parcela="' + n + '" title="Taxa para ' + n + 'x"><span>%</span>';
        chip.querySelector('input').addEventListener('input', function() {
            taxasRapidas[this.dataset.parcela] = this.value;
            const av = document.getElementById('porcentagem' + this.dataset.parcela + 'x');
            if (av) av.value = this.value;
            calcularParcelas();
        });
        parcelaTaxasRow.appendChild(chip);
    });
}
function atualizarVisibilidadeMiniOpcoes() {
    const parcelas = getParcelas();
    parcelaEspecificaOpcoes.classList.toggle('show', parcelas.length > 0);
    gerarChipsTaxa(parcelas);
}

// ‚îÄ‚îÄ Ajuste por produto ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getProductAdj(idx) {
    return productAdjustments[idx] || { descontoR:'', descontoP:'', acrescimoR:'', acrescimoP:'', comissao:'', comentario:'' };
}
function hasProductAdj(idx) {
    const a = productAdjustments[idx];
    if (!a) return false;
    return ['descontoR','descontoP','acrescimoR','acrescimoP','comissao'].some(k => a[k] !== '' && parseFloat(a[k]) !== 0);
}
function onPerProductAdjustChange() {
    const enabled = perProductAdjustCb.checked;
    perProductToggleLabel.classList.toggle('enabled', enabled);
    if (products.length > 0) displayTable(products);
    calcularParcelas();
}
function toggleAdjPanel(idx) {
    const panel = document.getElementById('adjPanel_' + idx);
    const btn   = document.getElementById('adjBtn_' + idx);
    if (!panel) return;
    const isOpen = panel.classList.toggle('open');
    btn.classList.toggle('active', isOpen);
}
function saveProductAdj(idx, field, value) {
    if (!productAdjustments[idx]) productAdjustments[idx] = { descontoR:'', descontoP:'', acrescimoR:'', acrescimoP:'', comissao:'', comentario:'' };
    productAdjustments[idx][field] = value;
    const row = document.querySelector('tr[data-prod-idx="' + idx + '"]');
    if (row) {
        const nameCell = row.cells[1];
        const adjAtivo = hasProductAdj(idx);
        const hasComment = (productAdjustments[idx].comentario || '').trim() !== '';
        const btn = document.getElementById('adjBtn_' + idx);
        let badge = nameCell.querySelector('.adj-badge');
        if (adjAtivo) { if (!badge) nameCell.insertAdjacentHTML('beforeend', '<span class="adj-badge">ajuste</span>'); if (btn) btn.classList.add('has-adj'); }
        else { if (badge) badge.remove(); if (btn) btn.classList.remove('has-adj'); }
        let cbadge = nameCell.querySelector('.comment-badge');
        if (hasComment) { if (!cbadge) nameCell.insertAdjacentHTML('beforeend', '<span class="comment-badge">üí¨</span>'); }
        else { if (cbadge) cbadge.remove(); }
    }
    calcularParcelas();
}
function resetProductAdj(idx) {
    productAdjustments[idx] = { descontoR:'', descontoP:'', acrescimoR:'', acrescimoP:'', comissao:'', comentario:'' };
    ['descontoR','descontoP','acrescimoR','acrescimoP','comissao'].forEach(f => {
        const el = document.getElementById('adj_' + idx + '_' + f);
        if (el) el.value = '';
    });
    const cel = document.getElementById('adj_' + idx + '_comentario');
    if (cel) cel.value = '';
    const row = document.querySelector('tr[data-prod-idx="' + idx + '"]');
    if (row) {
        const b1 = row.cells[1].querySelector('.adj-badge');   if (b1) b1.remove();
        const b2 = row.cells[1].querySelector('.comment-badge'); if (b2) b2.remove();
        const btn = document.getElementById('adjBtn_' + idx); if (btn) btn.classList.remove('has-adj');
    }
    calcularParcelas();
}

// ‚îÄ‚îÄ Google Sheets ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function isSheetsEnabled() { return document.getElementById('toggleSheets').checked; }
function onSheetsToggleChange() {
    const enabled = isSheetsEnabled();
    sheetsToggleLabel.classList.toggle('enabled', enabled);
    const btnLimpar = document.getElementById('btnLimparHistorico');
    if (btnLimpar) btnLimpar.style.display = enabled ? 'none' : '';
    const fonteEl = document.getElementById('historicoFonte');
    if (fonteEl) fonteEl.textContent = enabled ? '‚òÅÔ∏è Google Sheets' : 'üíæ Local';
}
async function salvarNoSheets(dados) {
    const resp = await fetch(SHEETS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date: new Date().toISOString(), titulo: dados.titulo || 'Sem t√≠tulo', payload: dados })
    });
    const json = await resp.json();
    if (json.error) throw new Error(json.error);
    return json;
}
async function carregarDoSheets() {
    const resp = await fetch(SHEETS_URL);
    if (!resp.ok) throw new Error('Erro HTTP: ' + resp.status);
    const json = await resp.json();
    if (json.error) throw new Error(json.error);
    return json;
}
async function excluirDoSheets(id) {
    const resp = await fetch(SHEETS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'delete', id: String(id) })
    });
    const json = await resp.json();
    if (json.error) throw new Error(json.error);
}

// ‚îÄ‚îÄ Hist√≥rico ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleHistoricoSection() { historicoSection.classList.toggle('show', toggleHistorico.checked); }
function toggleVerHistorico() {
    visualizarHistoricoSection.classList.toggle('show');
    if (visualizarHistoricoSection.classList.contains('show')) {
        carregarHistorico();
        setTimeout(() => visualizarHistoricoSection.scrollIntoView({ behavior:'smooth', block:'start' }), 100);
    }
}
function abrirHistoricoRapido() {
    if (!visualizarHistoricoSection.classList.contains('show')) {
        visualizarHistoricoSection.classList.add('show');
        carregarHistorico();
    }
    visualizarHistoricoSection.scrollIntoView({ behavior:'smooth', block:'start' });
}
function atualizarBadgeHistorico() {
    const h = JSON.parse(localStorage.getItem('historicoCalculos') || '[]');
    const badge = document.getElementById('fabBadge');
    if (h.length > 0) { badge.textContent = h.length > 99 ? '99+' : h.length; badge.style.display = 'flex'; }
    else badge.style.display = 'none';
}
function obterDataFormatada() {
    const dias = ['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];
    const a = new Date();
    return dias[a.getDay()] + ', ' + String(a.getDate()).padStart(2,'0') + '/' + String(a.getMonth()+1).padStart(2,'0') + '/' + a.getFullYear() + ' √†s ' + String(a.getHours()).padStart(2,'0') + ':' + String(a.getMinutes()).padStart(2,'0');
}
function obterDadosCalculadora() {
    const parcelasSelecionadas = [], parcelasTaxas = {};
    document.querySelectorAll('#parcelasAvancadas input[type="checkbox"]:checked').forEach(cb => {
        const n = parseInt(cb.value); parcelasSelecionadas.push(n);
        const ti = document.getElementById('porcentagem' + n + 'x');
        if (ti) parcelasTaxas[n] = ti.value;
    });
    return {
        valorBase: valorBaseInput.value,
        parcelaEspecifica: parcelaEspecificaInput.value,
        descontoPercentual: descontoPercentualInput.value,
        descontoFixo: descontoFixoInput.value,
        lucroAdicional: lucroAdicionalInput.value,
        acrescimoComissao: acrescimoComissaoInput.value,
        acrescimoPercentual: acrescimoPercentualInput.value,
        valorEntrada: valorEntradaInput.value,
        fatorArredondamento: fatorArredondamentoInput.value,
        resultado: resultadoTextarea.value,
        usandoListaProdutos: toggleProductList.checked,
        listaProdutosTexto: productListTextarea.value,
        produtosSelecionados: selectedProducts,
        todosProdutos: products,
        productAdjustments: productAdjustments,
        perProductAdjust: perProductAdjustCb.checked,
        opcoesAvancadasAtivo: toggleAdvancedOptions.checked,
        opcoes: {
            hideDinheiroPix: hideDinheiroPixCheckbox.checked,
            showDebito: showDebitoCheckbox.checked,
            showComparison: showComparisonCheckbox.checked,
            hideEntradaText: hideEntradaTextCheckbox.checked,
            showTotalValue: showTotalValueCheckbox.checked,
            boldProductName: boldProductNameCheckbox.checked,
            useEmoticons: useEmoticonsCheckbox.checked,
            especificaMostrarPix: especificaMostrarPixCb.checked,
            especificaMostrarTotal: especificaMostrarTotalCb.checked
        },
        porcentagemPix: porcentagemPixInput.value,
        porcentagemDebito: porcentagemDebitoInput.value,
        textos: {
            produtoPrefix: produtoPrefixInput.value,
            textoAdicionalLinha: textoAdicionalLinhaInput.value,
            textoCabecalho: textoCabecalhoMensagemTA.value,
            textoFinal: textoFinalMensagemTextarea.value,
            aiPrompt: aiPromptTextarea.value,
            emoticonDinheiro: emoticonDinheiroInput.value,
            emoticonCartao: emoticonCartaoInput.value
        },
        parcelasSelecionadas: parcelasSelecionadas,
        parcelasTaxas: parcelasTaxas
    };
}

function buildHistoricoHtml(id, titulo, dataStr, comentarios, dados) {
    let resumoValor = '';
    if (dados.usandoListaProdutos && dados.produtosSelecionados && dados.produtosSelecionados.length > 0)
        resumoValor = dados.produtosSelecionados.length + ' produto' + (dados.produtosSelecionados.length > 1 ? 's' : '') + ' selecionado' + (dados.produtosSelecionados.length > 1 ? 's' : '');
    else if (dados.valorBase)
        resumoValor = 'R$ ' + parseFloat(dados.valorBase).toLocaleString('pt-BR', {minimumFractionDigits:2});
    else resumoValor = 'Sem valor';
    const extras = [];
    if (dados.descontoPercentual) extras.push('Desconto: ' + dados.descontoPercentual + '%');
    if (dados.descontoFixo) extras.push('Desc. fixo: R$ ' + parseFloat(dados.descontoFixo).toFixed(2));
    if (dados.lucroAdicional) extras.push('Acr√©sc. R$: ' + parseFloat(dados.lucroAdicional).toFixed(2));
    if (dados.acrescimoPercentual) extras.push('Acr√©sc. %: ' + dados.acrescimoPercentual + '%');
    if (dados.acrescimoComissao) extras.push('Comiss√£o: R$ ' + parseFloat(dados.acrescimoComissao).toFixed(2));
    if (dados.valorEntrada) extras.push('Entrada: R$ ' + parseFloat(dados.valorEntrada).toFixed(2));
    if (dados.parcelaEspecifica) extras.push('Parcela: ' + dados.parcelaEspecifica + 'x');
    const sid = JSON.stringify(String(id));
    return '<div class="historico-item">' +
        '<div class="historico-header"><div class="historico-titulo">' + titulo + '</div><div class="historico-data">' + dataStr + '</div></div>' +
        (comentarios ? '<div class="historico-comentarios">üí¨ ' + comentarios + '</div>' : '') +
        '<div class="historico-dados"><strong>Valor:</strong> ' + resumoValor + (extras.length ? ' | ' + extras.join(' | ') : '') + '</div>' +
        '<div class="historico-acoes">' +
        '<button class="btn btn-primary" onclick="restaurarCalculo(' + sid + ')">üîÑ Restaurar</button>' +
        '<button class="btn btn-secondary" onclick="copiarResultadoHistorico(' + sid + ')">üìã Copiar</button>' +
        '<button class="btn btn-danger" onclick="excluirDoHistorico(' + sid + ')">üóëÔ∏è Excluir</button>' +
        '</div></div>';
}

async function salvarNoHistorico() {
    const titulo = historicoTituloInput.value.trim();
    if (!titulo) { alert('‚ö†Ô∏è Por favor, insira um t√≠tulo para o c√°lculo'); historicoTituloInput.focus(); return; }
    if (!resultadoTextarea.value) { alert('‚ö†Ô∏è N√£o h√° c√°lculo para salvar.'); return; }
    const dados = obterDadosCalculadora();
    dados.titulo = titulo;
    dados.comentarios = historicoComentariosTA.value.trim();
    if (isSheetsEnabled()) {
        showToast('‚òÅÔ∏è Salvando no Google Sheets...');
        try { await salvarNoSheets(dados); showToast('‚úÖ Salvo no Google Sheets!'); }
        catch(e) { showToast('‚ùå Erro ao salvar no Sheets: ' + e.message); return; }
    } else {
        const h = JSON.parse(localStorage.getItem('historicoCalculos') || '[]');
        h.unshift({ id: Date.now(), data: obterDataFormatada(), titulo: titulo, comentarios: dados.comentarios, dados: dados });
        localStorage.setItem('historicoCalculos', JSON.stringify(h));
        atualizarBadgeHistorico();
        showToast('‚úÖ C√°lculo salvo no hist√≥rico!');
    }
    historicoTituloInput.value = '';
    historicoComentariosTA.value = '';
}

async function carregarHistorico() {
    const fonteEl = document.getElementById('historicoFonte');
    if (isSheetsEnabled()) {
        if (fonteEl) fonteEl.textContent = '‚òÅÔ∏è Google Sheets';
        historicoLista.innerHTML = '<p style="text-align:center;color:var(--text-secondary)">‚è≥ Carregando do Google Sheets...</p>';
        try {
            const registros = await carregarDoSheets();
            _sheetsCache = registros;
            if (!registros.length) { historicoLista.innerHTML = '<div class="empty-historico"><div class="empty-historico-icon">üì≠</div><p>Nenhum registro no Sheets</p></div>'; return; }
            let html = '';
            registros.forEach(function(item) {
                const dados = typeof item.payload === 'string' ? JSON.parse(item.payload) : (item.payload || {});
                const dataF = item.date ? new Date(item.date).toLocaleString('pt-BR') : '';
                html += buildHistoricoHtml(item.id, item.titulo, dataF, dados.comentarios || '', dados);
            });
            historicoLista.innerHTML = html;
        } catch(e) { historicoLista.innerHTML = '<div class="error-message">‚ùå Erro ao carregar do Sheets: ' + e.message + '</div>'; }
    } else {
        if (fonteEl) fonteEl.textContent = 'üíæ Local';
        const h = JSON.parse(localStorage.getItem('historicoCalculos') || '[]');
        if (!h.length) { historicoLista.innerHTML = '<div class="empty-historico"><div class="empty-historico-icon">üì≠</div><p>Nenhum c√°lculo salvo ainda</p><small>Salve seus c√°lculos para acess√°-los depois!</small></div>'; return; }
        let html = '';
        h.forEach(function(item) { html += buildHistoricoHtml(item.id, item.titulo, item.data, item.comentarios, item.dados); });
        historicoLista.innerHTML = html;
    }
}

function restaurarCalculo(id) {
    let dados, tituloItem;
    if (isSheetsEnabled()) {
        const reg = _sheetsCache.find(function(r) { return String(r.id) === String(id); });
        if (!reg) { alert('Registro n√£o encontrado'); return; }
        dados = typeof reg.payload === 'string' ? JSON.parse(reg.payload) : (reg.payload || {});
        tituloItem = reg.titulo;
    } else {
        const h = JSON.parse(localStorage.getItem('historicoCalculos') || '[]');
        const it = h.find(function(r) { return String(r.id) === String(id); });
        if (!it) { alert('Registro n√£o encontrado'); return; }
        dados = it.dados;
        tituloItem = it.titulo;
    }
    valorBaseInput.value = dados.valorBase || '';
    parcelaEspecificaInput.value = dados.parcelaEspecifica || '';
    descontoPercentualInput.value = dados.descontoPercentual || '';
    descontoFixoInput.value = dados.descontoFixo || '';
    lucroAdicionalInput.value = dados.lucroAdicional || '';
    acrescimoComissaoInput.value = dados.acrescimoComissao || '';
    acrescimoPercentualInput.value = dados.acrescimoPercentual || '';
    valorEntradaInput.value = dados.valorEntrada || '';
    fatorArredondamentoInput.value = dados.fatorArredondamento || '1';
    if (dados.porcentagemPix) porcentagemPixInput.value = dados.porcentagemPix;
    if (dados.porcentagemDebito) porcentagemDebitoInput.value = dados.porcentagemDebito;
    if (dados.textos) {
        produtoPrefixInput.value = dados.textos.produtoPrefix || '‚û°Ô∏è ';
        textoAdicionalLinhaInput.value = dados.textos.textoAdicionalLinha || '';
        textoCabecalhoMensagemTA.value = dados.textos.textoCabecalho || '';
        textoFinalMensagemTextarea.value = dados.textos.textoFinal || '';
        aiPromptTextarea.value = dados.textos.aiPrompt || aiPromptTextarea.value;
        emoticonDinheiroInput.value = dados.textos.emoticonDinheiro || 'üí∏ ';
        emoticonCartaoInput.value = dados.textos.emoticonCartao || 'üí≥ ';
    }
    productAdjustments = dados.productAdjustments || {};
    perProductAdjustCb.checked = dados.perProductAdjust || false;
    perProductToggleLabel.classList.toggle('enabled', perProductAdjustCb.checked);
    if (dados.usandoListaProdutos) {
        toggleProductList.checked = true;
        productListTextarea.value = dados.listaProdutosTexto || '';
        if (dados.todosProdutos && dados.todosProdutos.length > 0) {
            products = dados.todosProdutos;
            displayTable(products);
            if (dados.produtosSelecionados && dados.produtosSelecionados.length > 0) {
                selectedProducts = dados.produtosSelecionados;
                setTimeout(function() {
                    dados.produtosSelecionados.forEach(function(ps) {
                        const idx = products.findIndex(function(p) { return p.produto === ps.produto && p.preco === ps.preco; });
                        if (idx !== -1) { const cb = document.querySelector('.product-checkbox[value="' + idx + '"]'); if (cb) cb.checked = true; }
                    });
                }, 100);
            }
        }
        toggleProductListSection();
    } else {
        toggleProductList.checked = false;
        if (productListSection.classList.contains('show')) toggleProductListSection();
    }
    if (dados.opcoes) {
        hideDinheiroPixCheckbox.checked = dados.opcoes.hideDinheiroPix || false;
        showDebitoCheckbox.checked = dados.opcoes.showDebito || false;
        showComparisonCheckbox.checked = dados.opcoes.showComparison || false;
        hideEntradaTextCheckbox.checked = dados.opcoes.hideEntradaText || false;
        showTotalValueCheckbox.checked = dados.opcoes.showTotalValue || false;
        boldProductNameCheckbox.checked = dados.opcoes.boldProductName !== undefined ? dados.opcoes.boldProductName : true;
        useEmoticonsCheckbox.checked = dados.opcoes.useEmoticons || false;
        if (dados.opcoes.especificaMostrarPix !== undefined) syncChipPix(dados.opcoes.especificaMostrarPix);
        if (dados.opcoes.especificaMostrarTotal !== undefined) syncChipTotal(dados.opcoes.especificaMostrarTotal);
    }
    if (dados.opcoesAvancadasAtivo) {
        toggleAdvancedOptions.checked = true; toggleAdvancedSection();
        document.querySelectorAll('#parcelasAvancadas input[type="checkbox"]').forEach(function(cb) { cb.checked = false; togglePorcentagemInput(parseInt(cb.value), false); });
        if (dados.parcelasSelecionadas) {
            dados.parcelasSelecionadas.forEach(function(n) {
                const cb = document.getElementById('parcela' + n + 'x');
                if (cb) { cb.checked = true; togglePorcentagemInput(n, true); }
                if (dados.parcelasTaxas && dados.parcelasTaxas[n]) { const ti = document.getElementById('porcentagem' + n + 'x'); if (ti) ti.value = dados.parcelasTaxas[n]; }
            });
        }
    } else {
        toggleAdvancedOptions.checked = false;
        if (advancedOptionsDiv.classList.contains('show')) toggleAdvancedSection();
    }
    toggleVerHistorico();
    atualizarResumoDescontos();
    atualizarVisibilidadeMiniOpcoes();
    calcularParcelas();
    window.scrollTo({ top:0, behavior:'smooth' });
    showToast('‚úÖ C√°lculo "' + tituloItem + '" restaurado!');
}

function copiarResultadoHistorico(id) {
    let resultado, titulo;
    if (isSheetsEnabled()) {
        const reg = _sheetsCache.find(function(r) { return String(r.id) === String(id); });
        if (!reg) { alert('Resultado n√£o encontrado'); return; }
        const dados = typeof reg.payload === 'string' ? JSON.parse(reg.payload) : (reg.payload || {});
        resultado = dados.resultado; titulo = reg.titulo;
    } else {
        const h = JSON.parse(localStorage.getItem('historicoCalculos') || '[]');
        const it = h.find(function(r) { return String(r.id) === String(id); });
        if (!it) { alert('Resultado n√£o encontrado'); return; }
        resultado = it.dados.resultado; titulo = it.titulo;
    }
    if (!resultado) { alert('Resultado n√£o encontrado'); return; }
    navigator.clipboard.writeText(resultado).then(function() { showToast('‚úÖ Resultado de "' + titulo + '" copiado!'); });
}

async function excluirDoHistorico(id) {
    if (!confirm('‚ö†Ô∏è Deseja realmente excluir este registro?')) return;
    if (isSheetsEnabled()) {
        showToast('‚òÅÔ∏è Excluindo do Sheets...');
        try {
            await excluirDoSheets(id);
            _sheetsCache = _sheetsCache.filter(function(r) { return String(r.id) !== String(id); });
            showToast('‚úÖ Registro exclu√≠do do Sheets!');
            carregarHistorico();
        } catch(e) { showToast('‚ùå Erro ao excluir: ' + e.message); }
    } else {
        let h = JSON.parse(localStorage.getItem('historicoCalculos') || '[]');
        h = h.filter(function(r) { return String(r.id) !== String(id); });
        localStorage.setItem('historicoCalculos', JSON.stringify(h));
        atualizarBadgeHistorico(); carregarHistorico();
        showToast('‚úÖ Registro exclu√≠do!');
    }
}

function limparHistoricoCompleto() {
    if (isSheetsEnabled()) { showToast('‚ö†Ô∏è No modo Sheets, exclua os registros individualmente.'); return; }
    if (!confirm('‚ö†Ô∏è Isso ir√° excluir TODOS os registros locais. Deseja continuar?')) return;
    localStorage.removeItem('historicoCalculos');
    atualizarBadgeHistorico(); carregarHistorico();
    showToast('‚úÖ Hist√≥rico local limpo!');
}

// ‚îÄ‚îÄ Se√ß√µes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleProductListSection() {
    productListSection.classList.toggle('show', toggleProductList.checked);
    valorBaseInput.disabled = toggleProductList.checked;
    if (!toggleProductList.checked) { products = []; selectedProducts = []; productListResult.innerHTML = ''; productAdjustments = {}; }
    calcularParcelas();
}
function toggleAdvancedSection() {
    advancedOptionsDiv.classList.toggle('show', toggleAdvancedOptions.checked);
    toggleDebitoPixPorcentagemInputs();
    document.querySelectorAll('#parcelasAvancadas input[type="checkbox"]').forEach(function(cb) { togglePorcentagemInput(parseInt(cb.value), cb.checked); });
    calcularParcelas();
}
function togglePorcentagemInput(n, isChecked) {
    const c = document.getElementById('porcentagem' + n + 'xContainer');
    if (c) c.classList.toggle('show', isChecked && toggleAdvancedOptions.checked);
}
function toggleDebitoPixPorcentagemInputs() {
    porcentagemPixContainer.classList.toggle('show', !hideDinheiroPixCheckbox.checked && toggleAdvancedOptions.checked);
    porcentagemDebitoContainer.classList.toggle('show', showDebitoCheckbox.checked && toggleAdvancedOptions.checked);
}

// ‚îÄ‚îÄ Checkboxes avan√ßadas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function gerarCheckboxesAvancadas() {
    parcelasAvancadasDiv.innerHTML = '';
    for (let i = 1; i <= 18; i++) {
        const div = document.createElement('div'); div.className = 'checkbox-item';
        const pg = document.createElement('div'); pg.className = 'parcela-input-group';
        const input = document.createElement('input');
        input.type = 'checkbox'; input.id = 'parcela' + i + 'x'; input.value = i;
        input.checked = parcelasPadrao.includes(i);
        input.addEventListener('change', function() { togglePorcentagemInput(i, input.checked); calcularParcelas(); });
        const label = document.createElement('label'); label.htmlFor = 'parcela' + i + 'x'; label.textContent = i + 'x';
        pg.appendChild(input); pg.appendChild(label);
        const pc = document.createElement('div'); pc.className = 'percent-input-container'; pc.id = 'porcentagem' + i + 'xContainer';
        if (input.checked) pc.classList.add('show');
        const pi = document.createElement('input'); pi.type = 'number'; pi.id = 'porcentagem' + i + 'x';
        pi.value = (taxasDeJurosPadrao[i] * 100).toFixed(2);
        pi.addEventListener('input', calcularParcelas);
        pc.appendChild(pi); pc.appendChild(document.createTextNode('%'));
        pg.appendChild(pc); div.appendChild(pg); parcelasAvancadasDiv.appendChild(div);
    }
}

// ‚îÄ‚îÄ Lista de produtos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function processWithAI() {
    const rawText = productListTextarea.value;
    if (!rawText) { displayErrorList('Por favor, cole o texto para a IA processar.'); return; }
    productListLoading.classList.add('active'); productListResult.innerHTML = '';
    try {
        const response = await fetch("https://caixa-kal3.vercel.app/api/groq", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ systemPrompt: aiPromptTextarea.value, messages: rawText })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || data.message || "Erro na requisi√ß√£o");
        if (data.choices && data.choices[0]) { productListTextarea.value = data.choices[0].message.content; processList(); }
        else throw new Error("Resposta da IA inv√°lida");
    } catch(e) { displayErrorList('‚ùå Erro na IA: ' + e.message); }
    finally { productListLoading.classList.remove('active'); }
}
function processList() {
    const list = productListTextarea.value;
    if (!list) { displayErrorList('Por favor, cole a lista de produtos.'); return; }
    productListLoading.classList.add('active'); productListResult.innerHTML = '';
    try {
        products = parseProducts(list);
        productAdjustments = {};
        displayTable(products);
        selectedProducts = [];
        handleProductSelection();
    } catch(e) { displayErrorList('‚ùå Erro: ' + e.message); }
    finally { productListLoading.classList.remove('active'); }
}
function parseProducts(text) {
    const cleanText = text.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]|\u00A9|\u00AE|[\u2000-\u3300]/g, '');
    const lines = cleanText.split('\n');
    const prods = [];
    const priceRegex = /(?:R\$\s*|[-])?\s*([\d\.]+,?\d{2}|\d+)\s*$/;
    lines.forEach(function(line) {
        const trimmed = line.trim();
        if (!trimmed || trimmed.match(/^[üìåüì¢‚ìÇÔ∏è‚ú≥Ô∏è‚ùá‚òëÔ∏èüì∫]/)) return;
        const match = trimmed.match(priceRegex);
        if (match) {
            const price = parseFloat(match[1].replace(/\./g,'').replace(',','.'));
            const name = trimmed.substring(0, match.index).replace(/`|\*|\-/g,'').trim();
            if (name && !isNaN(price)) prods.push({ produto: name, preco: price });
        }
    });
    if (!prods.length) throw new Error('Nenhum produto encontrado.');
    return prods;
}
function displayTable(prods) {
    const adjMode = perProductAdjustCb.checked;
    const colAdj = adjMode ? '<th class="col-adj">‚úèÔ∏è</th>' : '';
    let html = '<table><thead><tr><th><input type="checkbox" id="selectAllProducts"></th><th>Produto</th><th>Pre√ßo</th>' + colAdj + '<th>üîç</th></tr></thead><tbody>';
    prods.forEach(function(p, i) {
        const price = 'R$ ' + p.preco.toLocaleString('pt-BR', {minimumFractionDigits:2});
        const adj = getProductAdj(i);
        const hasAdj = hasProductAdj(i);
        const btnClass = 'btn-adj' + (hasAdj ? ' has-adj' : '');
        const hasComment = (adj.comentario || '').trim() !== '';
        const nameBadges = (hasAdj ? '<span class="adj-badge">ajuste</span>' : '') + (hasComment ? '<span class="comment-badge">üí¨</span>' : '');
        const adjColTd = adjMode ? ('<td class="col-adj"><button class="' + btnClass + '" id="adjBtn_' + i + '" onclick="toggleAdjPanel(' + i + ')" title="Ajuste individual">‚úèÔ∏è</button></td>') : '';
        html += '<tr data-prod-idx="' + i + '"><td><input type="checkbox" class="product-checkbox" value="' + i + '"></td><td>' + p.produto + nameBadges + '</td><td>' + price + '</td>' + adjColTd + '<td><a href="https://www.google.com/search?tbm=isch&q=' + encodeURIComponent(p.produto) + '" target="_blank">üîç</a></td></tr>';
        if (adjMode) {
            const colspan = adjMode ? 5 : 4;
            html += '<tr class="product-adj-row" id="adjRow_' + i + '"><td colspan="' + colspan + '"><div class="adj-panel" id="adjPanel_' + i + '">' +
                '<div class="adj-panel-title"><span>‚úèÔ∏è Ajuste: <strong>' + p.produto + '</strong></span><button class="adj-reset" onclick="resetProductAdj(' + i + ')">‚Ü∫ Limpar</button></div>' +
                '<div class="adj-fields">' +
                '<div class="adj-field"><label>Desconto R$</label><div class="adj-field-inner"><span>R$</span><input type="number" step="0.01" min="0" placeholder="0" value="' + (adj.descontoR||'') + '" oninput="saveProductAdj(' + i + ',\'descontoR\',this.value)" id="adj_' + i + '_descontoR"></div></div>' +
                '<div class="adj-field"><label>Desconto %</label><div class="adj-field-inner"><input type="number" step="0.01" min="0" max="100" placeholder="0" value="' + (adj.descontoP||'') + '" oninput="saveProductAdj(' + i + ',\'descontoP\',this.value)" id="adj_' + i + '_descontoP"><span>%</span></div></div>' +
                '<div class="adj-field"><label>Acr√©scimo R$</label><div class="adj-field-inner"><span>R$</span><input type="number" step="0.01" min="0" placeholder="0" value="' + (adj.acrescimoR||'') + '" oninput="saveProductAdj(' + i + ',\'acrescimoR\',this.value)" id="adj_' + i + '_acrescimoR"></div></div>' +
                '<div class="adj-field"><label>Acr√©scimo %</label><div class="adj-field-inner"><input type="number" step="0.01" min="0" placeholder="0" value="' + (adj.acrescimoP||'') + '" oninput="saveProductAdj(' + i + ',\'acrescimoP\',this.value)" id="adj_' + i + '_acrescimoP"><span>%</span></div></div>' +
                '<div class="adj-field"><label>Comiss√£o R$</label><div class="adj-field-inner"><span>R$</span><input type="number" step="0.01" min="0" placeholder="0" value="' + (adj.comissao||'') + '" oninput="saveProductAdj(' + i + ',\'comissao\',this.value)" id="adj_' + i + '_comissao"></div></div>' +
                '</div>' +
                '<div class="adj-comment-row"><label>üí¨ Coment√°rio</label><textarea class="adj-comment-input" placeholder="Observa√ß√µes sobre este produto..." oninput="saveProductAdj(' + i + ',\'comentario\',this.value)" id="adj_' + i + '_comentario">' + (adj.comentario||'') + '</textarea></div>' +
                '</div></td></tr>';
        }
    });
    html += '</tbody></table>';
    const badge = '<span class="product-count-badge">' + prods.length + ' produto' + (prods.length > 1 ? 's' : '') + ' encontrado' + (prods.length > 1 ? 's' : '') + '</span>';
    productListResult.innerHTML = badge + html;
    document.getElementById('selectAllProducts').addEventListener('change', function(e) {
        document.querySelectorAll('.product-checkbox').forEach(function(cb) { cb.checked = e.target.checked; });
        handleProductSelection();
    });
    document.querySelectorAll('.product-checkbox').forEach(function(cb) { cb.addEventListener('change', handleProductSelection); });
}
function handleProductSelection() {
    selectedProducts = [];
    document.querySelectorAll('.product-checkbox:checked').forEach(function(cb) {
        const p = products[parseInt(cb.value)];
        if (p) selectedProducts.push(Object.assign({}, p, { _idx: parseInt(cb.value) }));
    });
    calcularParcelas();
}
function displayErrorList(msg) { productListResult.innerHTML = '<div class="error-message">' + msg + '</div>'; }

// ‚îÄ‚îÄ C√°lculo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function arredondarParaMultiplo(valor, fator) {
    if (fator <= 0) fator = 1;
    return Math.ceil(valor / fator) * fator;
}
function calcularValorComDesconto(valorBase, overrides) {
    let valor = valorBase;
    const ov = overrides || {};
    const acrescimoPerc = parseFloat(ov.acrescimoP !== undefined && ov.acrescimoP !== '' ? ov.acrescimoP : acrescimoPercentualInput.value) || 0;
    const lucroFixo     = parseFloat(ov.acrescimoR !== undefined && ov.acrescimoR !== '' ? ov.acrescimoR : lucroAdicionalInput.value) || 0;
    const acrescimoFix  = parseFloat(ov.comissao   !== undefined && ov.comissao   !== '' ? ov.comissao   : acrescimoComissaoInput.value) || 0;
    const descontoPerc  = parseFloat(ov.descontoP  !== undefined && ov.descontoP  !== '' ? ov.descontoP  : descontoPercentualInput.value) || 0;
    const descontoFix   = parseFloat(ov.descontoR  !== undefined && ov.descontoR  !== '' ? ov.descontoR  : descontoFixoInput.value) || 0;
    if (acrescimoPerc > 0) valor *= (1 + acrescimoPerc / 100);
    if (lucroFixo     > 0) valor += lucroFixo;
    if (acrescimoFix  > 0) valor += acrescimoFix;
    if (descontoPerc  > 0) valor *= (1 - descontoPerc / 100);
    if (descontoFix   > 0) valor -= descontoFix;
    return Math.max(0, valor);
}
function atualizarResumoDescontos() {
    const base = parseFloat(valorBaseInput.value) || 0;
    if (base === 0) { discountSummary.classList.remove('active'); return; }
    const ap = parseFloat(acrescimoPercentualInput.value) || 0;
    const lf = parseFloat(lucroAdicionalInput.value) || 0;
    const af = parseFloat(acrescimoComissaoInput.value) || 0;
    const dp = parseFloat(descontoPercentualInput.value) || 0;
    const df = parseFloat(descontoFixoInput.value) || 0;
    if (!ap && !lf && !af && !dp && !df) { discountSummary.classList.remove('active'); return; }
    let det = [], vf = base;
    det.push('üíµ Valor inicial: R$ ' + base.toLocaleString('pt-BR',{minimumFractionDigits:2}));
    if (ap > 0) { const v = base*(ap/100); vf+=v; det.push('üìà Acr√©scimo '+ap+'%: +R$ '+v.toLocaleString('pt-BR',{minimumFractionDigits:2})); }
    if (lf > 0) { vf+=lf; det.push('üí∞ Acr√©scimo R$: +R$ '+lf.toLocaleString('pt-BR',{minimumFractionDigits:2})); }
    if (af > 0) { vf+=af; det.push('ü§ù Comiss√£o: +R$ '+af.toLocaleString('pt-BR',{minimumFractionDigits:2})); }
    if (dp > 0) { const v=vf*(dp/100); vf-=v; det.push('üìâ Desconto '+dp+'%: -R$ '+v.toLocaleString('pt-BR',{minimumFractionDigits:2})); }
    if (df > 0) { vf-=df; det.push('üí∏ Desconto fixo: -R$ '+df.toLocaleString('pt-BR',{minimumFractionDigits:2})); }
    det.push('<strong>üí∞ Valor base final: R$ '+vf.toLocaleString('pt-BR',{minimumFractionDigits:2})+'</strong>');
    const dif = vf - base;
    if (Math.abs(dif) > 0.001) {
        if (dif < 0) det.push('<strong style="color:var(--success-color)">üíö Economia: R$ '+Math.abs(dif).toLocaleString('pt-BR',{minimumFractionDigits:2})+' ('+(Math.abs(dif)/base*100).toFixed(1)+'%)</strong>');
        else det.push('<strong style="color:var(--accent-color)">üìä Acr√©scimo total: R$ '+dif.toLocaleString('pt-BR',{minimumFractionDigits:2})+' (+'+(dif/base*100).toFixed(1)+'%)</strong>');
    }
    discountDetails.innerHTML = det.join('<br>');
    discountSummary.classList.add('active');
}
function getTaxa(parcelas) {
    const parcelasRapidas = getParcelas();
    if (parcelasRapidas.length > 0 && parcelas !== 'pix' && parcelas !== 'debito') {
        if (taxasRapidas[parcelas] !== undefined) return parseFloat(taxasRapidas[parcelas]) / 100;
        return taxasDeJurosPadrao[parcelas] || 0;
    }
    if (toggleAdvancedOptions.checked) {
        if (parcelas === 'pix') return (parseFloat(porcentagemPixInput.value) || 0) / 100;
        if (parcelas === 'debito') return (parseFloat(porcentagemDebitoInput.value) || 0) / 100;
        const inp = document.getElementById('porcentagem' + parcelas + 'x');
        return inp ? (parseFloat(inp.value) || 0) / 100 : (taxasDeJurosPadrao[parcelas] || 0);
    }
    return taxasDeJurosPadrao[parcelas] || 0;
}
function getParcelasSelecionadas() {
    const parcelas = getParcelas();
    if (parcelas.length > 0) return { especifica:true, parcelas:parcelas };
    if (toggleAdvancedOptions.checked) {
        const sel = [];
        document.querySelectorAll('#parcelasAvancadas input[type="checkbox"]:checked').forEach(function(cb) { sel.push(parseInt(cb.value)); });
        return { especifica:false, parcelas:sel.sort(function(a,b){return a-b;}) };
    }
    return { especifica:false, parcelas:parcelasPadrao.slice() };
}
function calcularParcelas() {
    const entrada = parseFloat(valorEntradaInput.value) || 0;
    const res = [];
    const config = getParcelasSelecionadas();
    if (selectedProducts.length > 0) {
        selectedProducts.forEach(function(p, i) {
            const overrides = (perProductAdjustCb.checked && p._idx !== undefined) ? getProductAdj(p._idx) : null;
            let name = boldProductNameCheckbox.checked ? '*' + p.produto + '*' : p.produto;
            if (produtoPrefixInput.value) name = produtoPrefixInput.value + ' ' + name;
            const r = calcularParcelasParaUmProduto(p.preco, entrada, textoAdicionalLinhaInput.value, showTotalValueCheckbox.checked, name, config, p.preco, overrides);
            if (r) res.push(r);
            if (i < selectedProducts.length - 1) res.push('\n' + '‚îÅ'.repeat(20));
        });
    } else {
        const base = parseFloat(valorBaseInput.value);
        if (!isNaN(base) && base > 0) {
            const r = calcularParcelasParaUmProduto(base, entrada, textoAdicionalLinhaInput.value, showTotalValueCheckbox.checked, "", config, base, null);
            if (r) res.push(r);
        }
    }
    let final = res.slice();
    if (textoCabecalhoMensagemTA.value) final.unshift(textoCabecalhoMensagemTA.value + '\n');
    if (textoFinalMensagemTextarea.value) final.push('\n' + textoFinalMensagemTextarea.value);
    resultadoTextarea.value = final.join('\n');
}
function calcularParcelasParaUmProduto(valorBase, ent, txtAdd, showTot, nome, config, valorOriginal, overrides) {
    const res = [];
    const fator = parseFloat(fatorArredondamentoInput.value) || 1;
    const emoAtivo = useEmoticonsCheckbox.checked;
    const emoDinheiro = emoAtivo ? emoticonDinheiroInput.value : "";
    const emoCartao   = emoAtivo ? emoticonCartaoInput.value   : "";
    const valLiq = calcularValorComDesconto(valorBase, overrides);
    if (nome) res.push(nome);
    const showEnt = !hideEntradaTextCheckbox.checked && ent > 0;
    const txtEnt  = showEnt ? 'Entrada de R$ ' + ent.toLocaleString('pt-BR',{minimumFractionDigits:2}) + ' + ' : '';
    const aParc   = valLiq - ent;
    const mostrarPix   = config.especifica ? especificaMostrarPixCb.checked   : !hideDinheiroPixCheckbox.checked;
    const mostrarTotal = config.especifica ? especificaMostrarTotalCb.checked : showTot;
    if (valLiq >= ent) {
        if (mostrarPix) {
            const v = arredondarParaMultiplo(valLiq / (1 - getTaxa('pix')), fator);
            let linhaPix = emoDinheiro + 'Dinheiro/Pix: R$ ' + v.toLocaleString('pt-BR',{minimumFractionDigits:2});
            if (showComparisonCheckbox.checked && valorOriginal !== valLiq) linhaPix += ' (economize R$ ' + (valorOriginal - v).toLocaleString('pt-BR',{minimumFractionDigits:2}) + ')';
            res.push(linhaPix);
        }
        if (!config.especifica && showDebitoCheckbox.checked && ent === 0) {
            const v = arredondarParaMultiplo(valLiq / (1 - getTaxa('debito')), fator);
            res.push(emoCartao + 'D√©bito: R$ ' + v.toLocaleString('pt-BR',{minimumFractionDigits:2}));
        }
        config.parcelas.forEach(function(p) {
            const vParc = arredondarParaMultiplo((aParc / (1 - getTaxa(p))) / p, fator);
            let linha = emoCartao + txtEnt + p + 'x de R$ ' + vParc.toLocaleString('pt-BR',{minimumFractionDigits:2});
            if (mostrarTotal) linha += ' (R$ ' + (ent + vParc * p).toLocaleString('pt-BR',{minimumFractionDigits:2}) + ')';
            if (txtAdd) linha += ' ' + txtAdd;
            res.push(linha);
        });
    }
    return res.join('\n');
}

// ‚îÄ‚îÄ Copiar / Limpar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function copiarTexto() {
    if (!resultadoTextarea.value) return;
    navigator.clipboard.writeText(resultadoTextarea.value).then(function() { showToast('‚úÖ Texto copiado!'); });
}
function limparCampos() {
    if (!confirm('‚ö†Ô∏è Deseja realmente limpar todos os campos?')) return;
    valorBaseInput.value = ''; parcelaEspecificaInput.value = '';
    descontoPercentualInput.value = ''; descontoFixoInput.value = '';
    lucroAdicionalInput.value = ''; acrescimoComissaoInput.value = '';
    acrescimoPercentualInput.value = ''; valorEntradaInput.value = '';
    productListTextarea.value = ''; textoAdicionalLinhaInput.value = '';
    textoCabecalhoMensagemTA.value = ''; textoFinalMensagemTextarea.value = '';
    resultadoTextarea.value = '';
    products = []; selectedProducts = []; productAdjustments = {};
    productListResult.innerHTML = '';
    discountSummary.classList.remove('active');
    parcelaEspecificaInput.classList.remove('invalid');
    taxasRapidas = {};
    perProductAdjustCb.checked = false; perProductToggleLabel.classList.remove('enabled');
    especificaMostrarPixCb.checked = true; especificaMostrarTotalCb.checked = false;
    syncChipPix(true); syncChipTotal(false);
    atualizarVisibilidadeMiniOpcoes();
    calcularParcelas();
}

// ‚îÄ‚îÄ Event Listeners ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
valorBaseInput.addEventListener('input', function()          { atualizarResumoDescontos(); calcularParcelas(); });
descontoPercentualInput.addEventListener('input', function() { atualizarResumoDescontos(); calcularParcelas(); });
descontoFixoInput.addEventListener('input', function()       { atualizarResumoDescontos(); calcularParcelas(); });
lucroAdicionalInput.addEventListener('input', function()     { atualizarResumoDescontos(); calcularParcelas(); });
acrescimoComissaoInput.addEventListener('input', function()  { atualizarResumoDescontos(); calcularParcelas(); });
acrescimoPercentualInput.addEventListener('input', function(){ atualizarResumoDescontos(); calcularParcelas(); });
valorEntradaInput.addEventListener('input',        calcularParcelas);
fatorArredondamentoInput.addEventListener('input', calcularParcelas);
hideDinheiroPixCheckbox.addEventListener('change', function() { syncChipPix(!hideDinheiroPixCheckbox.checked); toggleDebitoPixPorcentagemInputs(); calcularParcelas(); });
showDebitoCheckbox.addEventListener('change',      function() { toggleDebitoPixPorcentagemInputs(); calcularParcelas(); });
showComparisonCheckbox.addEventListener('change',  calcularParcelas);
porcentagemPixInput.addEventListener('input',      calcularParcelas);
porcentagemDebitoInput.addEventListener('input',   calcularParcelas);
hideEntradaTextCheckbox.addEventListener('change', calcularParcelas);
showTotalValueCheckbox.addEventListener('change',  function() { syncChipTotal(showTotalValueCheckbox.checked); calcularParcelas(); });
boldProductNameCheckbox.addEventListener('change', calcularParcelas);
textoAdicionalLinhaInput.addEventListener('input', calcularParcelas);
produtoPrefixInput.addEventListener('input',       calcularParcelas);
textoFinalMensagemTextarea.addEventListener('input', calcularParcelas);
textoCabecalhoMensagemTA.addEventListener('input', calcularParcelas);
emoticonDinheiroInput.addEventListener('input',    calcularParcelas);
emoticonCartaoInput.addEventListener('input',      calcularParcelas);
parcelaEspecificaInput.addEventListener('input', function() {
    const parcelas = getParcelas();
    const raw = this.value.trim();
    const allValid = raw === '' || (parcelas.length > 0 && raw.split(',').every(function(s){ const n=parseInt(s.trim()); return !isNaN(n)&&n>=1&&n<=18; }));
    this.classList.toggle('invalid', raw !== '' && !allValid);
    const current = new Set(parcelas.map(String));
    Object.keys(taxasRapidas).forEach(function(k){ if (!current.has(k)) delete taxasRapidas[k]; });
    atualizarVisibilidadeMiniOpcoes();
    calcularParcelas();
});
selectAllButton.addEventListener('click', function() {
    document.querySelectorAll('#parcelasAvancadas input[type="checkbox"]').forEach(function(cb){ cb.checked=true; togglePorcentagemInput(parseInt(cb.value),true); });
    calcularParcelas();
});
deselectAllButton.addEventListener('click', function() {
    document.querySelectorAll('#parcelasAvancadas input[type="checkbox"]').forEach(function(cb){ cb.checked=false; togglePorcentagemInput(parseInt(cb.value),false); });
    calcularParcelas();
});
window.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.toggle-section').forEach(function(section) {
        section.addEventListener('click', function(e) {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'LABEL') {
                const cb = this.querySelector('input[type="checkbox"]');
                if (cb) { cb.checked = !cb.checked; cb.dispatchEvent(new Event('change')); }
            }
        });
    });
    syncChipPix(especificaMostrarPixCb.checked);
    syncChipTotal(especificaMostrarTotalCb.checked);
});

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
gerarCheckboxesAvancadas();
calcularParcelas();
atualizarBadgeHistorico();
</script>
</body>
</html>

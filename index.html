<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Parcelas Pro</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --accent-color: #FF9800;
            --danger-color: #f44336;
            --success-color: #4CAF50;
            --bg-primary: #f4f4f9;
            --bg-secondary: #fff;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #ddd;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-hover: 0 6px 20px rgba(0,0,0,0.15);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #e0e0e0 100%);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .container {
            width: 100%;
            max-width: 700px;
            background-color: var(--bg-secondary);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        h1 {
            background: linear-gradient(135deg, #4CAF50 0%, #2196F3 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--border-color);
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        .quick-links {
            text-align: center;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .quick-links a {
            color: var(--secondary-color);
            text-decoration: none;
            margin: 0 10px;
            transition: color 0.3s;
        }

        .quick-links a:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }

        .section-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .section-card:hover {
            box-shadow: var(--shadow-hover);
        }

        .section-title {
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group {
            margin-bottom: 20px;
            position: relative;
        }

        .input-with-icon {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 1.2rem;
            pointer-events: none;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        label small {
            font-weight: normal;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        input::placeholder {
            color: #999;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 14px 14px 14px 42px;
            font-size: 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            -moz-appearance: textfield;
            transition: all 0.3s ease;
        }

        input[type="number"]:focus, input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        input[type="number"].has-value {
            border-color: var(--success-color);
        }

        input[type="number"].invalid {
            border-color: var(--danger-color);
            background-color: #fff5f5;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            background-color: var(--bg-primary);
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            color: var(--text-primary);
            resize: vertical;
            transition: all 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        textarea#resultado {
            background: linear-gradient(135deg, #f0f0f0 0%, #e8e8e8 100%);
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        [data-theme="dark"] textarea#resultado {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
        }

        .toggle-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: var(--bg-primary);
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 54px;
        }

        .toggle-section:hover {
            background: var(--border-color);
        }

        .toggle-section input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .toggle-section label {
            margin: 0;
            cursor: pointer;
            flex: 1;
            user-select: none;
            font-size: 1rem;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }

        .collapsible-content.show {
            max-height: 5000px;
            transition: max-height 0.5s ease-in;
        }

        .option-group {
            border: 2px solid var(--border-color);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            background: var(--bg-primary);
        }

        .option-group h4 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .parcelas-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            flex-direction: column;
        }

        .parcela-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
            flex: 1;
        }

        .percent-input-container {
            display: none;
            align-items: center;
            gap: 5px;
        }

        .percent-input-container.show {
            display: flex;
        }

        .percent-input-container input {
            width: 70px;
            padding: 6px 8px;
            font-size: 13px;
        }

        .button-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 14px 24px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 48px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, #45a049 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #1976D2 100%);
            color: white;
        }

        .btn-accent {
            background: linear-gradient(135deg, var(--accent-color) 0%, #F57C00 100%);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            background: var(--border-color);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #d32f2f 100%);
            color: white;
        }

        .copy-message {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.5s ease;
            text-align: center;
            margin-top: 10px;
        }

        .copy-message.show {
            opacity: 1;
        }

        .info-badge {
            display: inline-block;
            background: var(--accent-color);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .discount-summary {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
            border-left: 4px solid var(--accent-color);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }

        [data-theme="dark"] .discount-summary {
            background: linear-gradient(135deg, #3d3520 0%, #2d2614 100%);
        }

        .discount-summary.active {
            display: block;
        }

        .discount-summary h4 {
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        .discount-summary p {
            margin: 5px 0;
            color: var(--text-primary);
        }

        .error-message {
            color: #d9534f;
            background: linear-gradient(135deg, #f2dede 0%, #ebcccc 100%);
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            border-left: 4px solid #d9534f;
        }

        #productListResult table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            border-radius: 10px;
            overflow: hidden;
        }

        #productListResult th, #productListResult td {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: center;
        }

        #productListResult th {
            background: linear-gradient(135deg, var(--primary-color) 0%, #45a049 100%);
            color: white;
            font-weight: 600;
        }

        #productListResult tr:hover {
            background: var(--bg-primary);
        }

        #productListResult a {
            color: var(--secondary-color);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #productListResult a:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }

        .loading-spinner {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .loading-spinner.active {
            display: block;
        }

        .spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        hr {
            border: 0;
            height: 2px;
            background: var(--border-color);
            margin: 20px 0;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            white-space: nowrap;
            z-index: 1000;
        }

        input[type="number"]:not(:placeholder-shown),
        input[type="text"]:not(:placeholder-shown) {
            border-color: var(--success-color);
            background: rgba(76, 175, 80, 0.05);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .discount-summary.active {
            animation: slideIn 0.3s ease;
        }

        .product-count-badge {
            background: var(--secondary-color);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Estilos do Hist√≥rico */
        .historico-item {
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .historico-item:hover {
            box-shadow: var(--shadow-hover);
            border-color: var(--primary-color);
        }

        .historico-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .historico-titulo {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary-color);
        }

        .historico-data {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .historico-comentarios {
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .historico-dados {
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-top: 10px;
        }

        .historico-dados strong {
            color: var(--primary-color);
        }

        .historico-acoes {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .historico-acoes button {
            flex: 1;
            padding: 8px 12px;
            font-size: 0.85rem;
        }

        .empty-historico {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-historico-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        /* Bot√£o flutuante de acesso r√°pido ao hist√≥rico */
        .fab-historico {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary-color) 0%, #1976D2 100%);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab-historico:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.6);
        }

        .fab-historico:active {
            transform: scale(0.95);
        }

        /* Badge de contador no FAB */
        .fab-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--bg-secondary);
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.5rem;
            }

            .parcelas-checkboxes {
                grid-template-columns: 1fr;
            }

            .button-row {
                grid-template-columns: 1fr;
            }

            .theme-toggle {
                position: static;
                margin-top: 10px;
            }

            .historico-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            /* Melhorar legibilidade de inputs no mobile */
            input[type="number"], input[type="text"] {
                font-size: 16px; /* Evita zoom autom√°tico no iOS */
            }

            textarea {
                font-size: 16px;
            }

            /* Bot√µes maiores no mobile */
            .btn {
                padding: 16px 20px;
                min-height: 52px;
            }

            /* Aumentar √°rea de toque dos checkboxes */
            .checkbox-item input[type="checkbox"] {
                width: 20px;
                height: 20px;
            }

            /* Melhorar visualiza√ß√£o do hist√≥rico em mobile */
            .historico-acoes {
                flex-direction: column;
            }

            .historico-acoes button {
                width: 100%;
            }

            /* Reduzir padding dos cards no mobile */
            .section-card {
                padding: 15px;
            }

            /* Quick access mobile */
            .quick-access-mobile {
                display: flex;
                gap: 8px;
                margin-bottom: 15px;
            }

            .quick-access-mobile .btn {
                flex: 1;
                font-size: 14px;
                padding: 12px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Calculadora de Parcelas Pro</h1>
            <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">üåì</button>
        </div>

        <div class="quick-links">
            <a href="https://calculadoracaixa.netlify.app/listas/" target="_blank">üìã Processamento de Lista</a>
            |
            <a href="https://calculadoracaixa.netlify.app/gestaoclick/" target="_blank">üì¶ Estoque</a>
        </div>

        <!-- Lista de Produtos -->
        <div class="toggle-section">
            <input type="checkbox" id="toggleProductList" onchange="toggleProductListSection()">
            <label for="toggleProductList">üì¶ Usar lista de produtos</label>
        </div>

        <div id="productListSection" class="collapsible-content">
            <div class="section-card">
                <div class="input-group">
                    <label for="productList">Cole a lista de produtos:</label>
                    <textarea id="productList" placeholder="Ex:&#10;iPhone 13 R$ 3.500,00&#10;Capa silicone R$ 50,00&#10;Fone Bluetooth R$ 150,00"></textarea>
                </div>
                <div class="button-row">
                    <button class="btn btn-secondary" onclick="processList()">üìä Processar Lista</button>
                    <button class="btn btn-accent" onclick="processWithAI()">‚ú® Processar com IA</button>
                </div>
                <div id="productListLoading" class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Processando...</p>
                </div>
                <div id="productListResult"></div>
            </div>
        </div>

        <!-- Valores Principais -->
        <div class="section-card">
            <div class="section-title">üíµ Valores Principais</div>
            
            <div class="input-group">
                <label for="valorBase">Valor Base (R$):</label>
                <div class="input-with-icon">
                    <span class="input-icon">üí≤</span>
                    <input type="number" id="valorBase" placeholder="Ex: 500.00" step="0.01">
                </div>
            </div>

            <div class="input-group">
                <label for="parcelaEspecifica">Parcela Espec√≠fica <small>(opcional - mostra apenas 1 parcela)</small>:</label>
                <div class="input-with-icon">
                    <span class="input-icon">üî¢</span>
                    <input type="number" id="parcelaEspecifica" placeholder="Ex: 8" step="1" min="1" max="18">
                </div>
            </div>
        </div>

        <!-- Acr√©scimos e Descontos -->
        <div class="section-card">
            <div class="section-title">üéÅ Acr√©scimos e Descontos</div>
            
            <div class="input-group">
                <label for="lucroAdicional">
                    Acr√©scimo/Lucro (R$) <small>(aplicado ao valor final)</small>
                    <span class="tooltip" data-tooltip="Valor adicional de lucro ou margem">‚ÑπÔ∏è</span>
                </label>
                <div class="input-with-icon">
                    <span class="input-icon">üìà</span>
                    <input type="number" id="lucroAdicional" placeholder="Ex: 50.00" step="0.01">
                </div>
            </div>
			<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="input-group">
                <label for="descontoFixo">Desconto em R$ <small>(aplicado antes dos juros)</small>:</label>
                <div class="input-with-icon">
                    <span class="input-icon">üí∏</span>
                    <input type="number" id="descontoFixo" placeholder="Ex: 50.00" step="0.01" min="0">
                </div>
            </div>

            <div class="input-group">
                <label for="descontoPercentual">
                    Desconto em % <small>(aplicado antes dos juros)</small>
                    <span class="tooltip" data-tooltip="Ex: 10% = R$500 vira R$450">‚ÑπÔ∏è</span>
                </label>
                <div class="input-with-icon">
                    <span class="input-icon">üìâ</span>
                    <input type="number" id="descontoPercentual" placeholder="Ex: 10" step="0.01" min="0" max="100">
                </div>
            </div>
			</div>



            <div class="input-group">
                <label for="descontoPixExtra">
                    Desconto EXTRA Pix % <small>(al√©m do desconto normal)</small>
                    <span class="tooltip" data-tooltip="Desconto adicional exclusivo para pagamento em Pix">‚ÑπÔ∏è</span>
                </label>
                <div class="input-with-icon">
                    <span class="input-icon">‚ö°</span>
                    <input type="number" id="descontoPixExtra" placeholder="Ex: 5" step="0.01" min="0" max="100">
                </div>
            </div>

            <div class="input-group">
                <label for="valorEntrada">Valor da Entrada (R$):</label>
                <div class="input-with-icon">
                    <span class="input-icon">üè¶</span>
                    <input type="number" id="valorEntrada" placeholder="Ex: 100.00" step="0.01" min="0">
                </div>
            </div>

            <div id="discountSummary" class="discount-summary">
                <h4>üìä Resumo de C√°lculos</h4>
                <p id="discountDetails"></p>
            </div>
        </div>

        <!-- Op√ß√µes Avan√ßadas -->
        <div class="toggle-section">
            <input type="checkbox" id="toggleAdvancedOptions" onchange="toggleAdvancedSection()">
            <label for="toggleAdvancedOptions">‚öôÔ∏è Op√ß√µes Avan√ßadas</label>
        </div>

        <div id="advancedOptions" class="collapsible-content">
            <div class="section-card">
                <div class="option-group">
                    <h4>ü§ñ Configura√ß√£o da IA (Groq)</h4>
                    <div class="input-group">
                        <textarea id="aiPrompt" style="height: 120px;">Voc√™ √© um assistente que extrai produtos e pre√ßos de textos bagun√ßados. 
Sua sa√≠da deve ser APENAS uma lista no formato: Nome do Produto R$ Valor.
Exemplo: 
iPhone 13 R$ 3.500,00
Capa silicone R$ 50,00

- Caso tenha informa√ß√µes adicionais do produto colocar entre par√™nteses, ap√≥s o nome do produto, no formato (informa√ß√£o 1/informa√ß√£o 2, etc)
- N√£o escreva introdu√ß√µes nem conclus√µes.</textarea>
                    </div>
                </div>

                <hr>

                <div class="option-group">
                    <h4>üéØ Arredondamento de Valores</h4>
                    <div class="input-group">
                        <label for="fatorArredondamento">Fator de arredondamento:</label>
                        <div class="input-with-icon">
                            <span class="input-icon">üîÑ</span>
                            <input type="number" id="fatorArredondamento" placeholder="Ex: 0.5, 0.2, 1" step="0.01" value="1" min="0.01">
                        </div>
                        <small style="color: var(--text-secondary); margin-top: 5px; display: block;">
                            üí° Exemplos: 1 = inteiro (5,51‚Üí6) | 0,5 = meio (5,51‚Üí5,50 ou 6,00) | 0,2 = 20 centavos (5,51‚Üí5,60)
                        </small>
                    </div>
                </div>

                <hr>

                <div class="option-group">
                    <h4>üìù Personalizar Texto de Sa√≠da</h4>
                    
                    <div class="checkbox-item">
                        <div class="parcela-input-group">
                            <input type="checkbox" id="hideDinheiroPix">
                            <label for="hideDinheiroPix">N√£o mostrar "Dinheiro/Pix"</label>
                            <div class="percent-input-container" id="porcentagemPixContainer">
                                <input type="number" id="porcentagemPix" placeholder="%" step="0.01" value="0">
                                <span>%</span>
                            </div>
                        </div>
                    </div>

                    <div class="checkbox-item">
                        <div class="parcela-input-group">
                            <input type="checkbox" id="showDebito">
                            <label for="showDebito">Mostrar "D√©bito"</label>
                            <div class="percent-input-container" id="porcentagemDebitoContainer">
                                <input type="number" id="porcentagemDebito" placeholder="%" step="0.01" value="2.5">
                                <span>%</span>
                            </div>
                        </div>
                    </div>

                    <div class="checkbox-item">
                        <div class="parcela-input-group">
                            <input type="checkbox" id="showComparison">
                            <label for="showComparison">Mostrar compara√ß√£o (economia vs sem desconto)</label>
                        </div>
                    </div>

                    <div class="checkbox-item">
                        <div class="parcela-input-group">
                            <input type="checkbox" id="hideEntradaText">
                            <label for="hideEntradaText">N√£o mostrar "Entrada"</label>
                        </div>
                    </div>

                    <div class="checkbox-item">
                        <div class="parcela-input-group">
                            <input type="checkbox" id="showTotalValue">
                            <label for="showTotalValue">Mostrar valor total (R$ XXXX)</label>
                        </div>
                    </div>

                    <div class="checkbox-item">
                        <div class="parcela-input-group">
                            <input type="checkbox" id="boldProductName" checked>
                            <label for="boldProductName">Nome do produto em negrito (*texto*)</label>
                        </div>
                    </div>
                </div>

                <hr>

                <div class="option-group">
                    <h4>‚úèÔ∏è Textos Personalizados</h4>
                    
                    <div class="input-group">
                        <label for="produtoPrefix">Prefixo do produto:</label>
                        <input type="text" id="produtoPrefix" placeholder="Ex: üì¶, ‚û°Ô∏è, ‚ú®" value="‚û°Ô∏è ">
                        <small style="color: var(--text-secondary); margin-top: 5px; display: block;">
                            Sugest√µes: üì± üçè üçé üì∫ üíª ‚ú≥Ô∏è üì¶ üîå ‚¨õ ‚ú® üéÅ
                        </small>
                    </div>

                    <div class="input-group">
                        <label for="textoAdicionalLinha">Texto adicional por linha:</label>
                        <input type="text" id="textoAdicionalLinha" placeholder="Ex: 'sem juros no cart√£o', 'frete gr√°tis'">
                    </div>

                    <div class="input-group">
                        <label for="textoCabecalhoMensagem">Mensagem de cabe√ßalho:</label>
                        <textarea id="textoCabecalhoMensagem" placeholder="Ex: 'Ol√°! Segue as condi√ß√µes de pagamento:'"></textarea>
                    </div>

                    <div class="input-group">
                        <label for="textoFinalMensagem">Texto final da mensagem:</label>
                        <textarea id="textoFinalMensagem" placeholder="Ex: 'Entre em contato para mais informa√ß√µes! üì±'"></textarea>
                    </div>
                </div>

                <hr>

                <div class="option-group">
                    <h4>üéØ Selecionar Parcelas e Taxa %</h4>
                    <div class="parcelas-checkboxes" id="parcelasAvancadas"></div>
                    <div class="button-row">
                        <button type="button" class="btn btn-outline" id="selectAll">‚úÖ Marcar Todas</button>
                        <button type="button" class="btn btn-outline" id="deselectAll">‚ùå Desmarcar Todas</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resultado -->
        <div class="section-card">
            <div class="section-title">üìã Resultado</div>
            <div class="input-group">
                <textarea id="resultado" readonly placeholder="Os valores de parcelamento aparecer√£o aqui..."></textarea>
            </div>
            <div class="button-row">
                <button type="button" class="btn btn-primary" onclick="copiarTexto()">üìã Copiar Texto</button>
                <button type="button" class="btn btn-outline" onclick="limparCampos()">üóëÔ∏è Limpar Tudo</button>
            </div>
            <div id="mensagemCopiado" class="copy-message">‚úÖ Texto copiado para √°rea de transfer√™ncia!</div>
        </div>

        <!-- Sistema de Hist√≥rico -->
        <div class="toggle-section">
            <input type="checkbox" id="toggleHistorico" onchange="toggleHistoricoSection()">
            <label for="toggleHistorico">üìö Salvar no Hist√≥rico</label>
        </div>

        <div id="historicoSection" class="collapsible-content">
            <div class="section-card">
                <div class="input-group">
                    <label for="historicoTitulo">T√≠tulo do c√°lculo:</label>
                    <div class="input-with-icon">
                        <span class="input-icon">üìù</span>
                        <input type="text" id="historicoTitulo" placeholder="Ex: Venda iPhone 13">
                    </div>
                </div>
                <div class="input-group">
                    <label for="historicoComentarios">Coment√°rios (opcional):</label>
                    <textarea id="historicoComentarios" placeholder="Observa√ß√µes sobre este c√°lculo..." style="min-height: 80px;"></textarea>
                </div>
                <div class="button-row">
                    <button class="btn btn-primary" onclick="salvarNoHistorico()">üíæ Salvar Agora</button>
                    <button class="btn btn-secondary" onclick="toggleVerHistorico()">üìã Ver Hist√≥rico</button>
                </div>
            </div>
        </div>

        <!-- Visualiza√ß√£o do Hist√≥rico -->
        <div id="visualizarHistoricoSection" class="collapsible-content">
            <div class="section-card">
                <div class="section-title">üìñ Hist√≥rico de C√°lculos</div>
                <div id="historicoLista"></div>
                <div class="button-row" style="margin-top: 15px;">
                    <button class="btn btn-outline" onclick="toggleVerHistorico()">‚¨ÖÔ∏è Voltar</button>
                    <button class="btn btn-danger" onclick="limparHistoricoCompleto()">üóëÔ∏è Limpar Hist√≥rico</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot√£o Flutuante de Acesso R√°pido ao Hist√≥rico -->
    <button class="fab-historico" onclick="abrirHistoricoRapido()" title="Ver hist√≥rico">
        üìö
        <span class="fab-badge" id="fabBadge" style="display: none;">0</span>
    </button>

    <script>
        // Elementos do DOM
        const valorBaseInput = document.getElementById('valorBase');
        const parcelaEspecificaInput = document.getElementById('parcelaEspecifica');
        const descontoPercentualInput = document.getElementById('descontoPercentual');
        const descontoFixoInput = document.getElementById('descontoFixo');
        const descontoPixExtraInput = document.getElementById('descontoPixExtra');
        const lucroAdicionalInput = document.getElementById('lucroAdicional');
        const valorEntradaInput = document.getElementById('valorEntrada');
        const resultadoTextarea = document.getElementById('resultado');
        const mensagemCopiado = document.getElementById('mensagemCopiado');
        const discountSummary = document.getElementById('discountSummary');
        const discountDetails = document.getElementById('discountDetails');

        const toggleAdvancedOptions = document.getElementById('toggleAdvancedOptions');
        const advancedOptionsDiv = document.getElementById('advancedOptions');
        const hideDinheiroPixCheckbox = document.getElementById('hideDinheiroPix');
        const showDebitoCheckbox = document.getElementById('showDebito');
        const showComparisonCheckbox = document.getElementById('showComparison');
        const hideEntradaTextCheckbox = document.getElementById('hideEntradaText');
        const showTotalValueCheckbox = document.getElementById('showTotalValue');
        const boldProductNameCheckbox = document.getElementById('boldProductName');
        const textoAdicionalLinhaInput = document.getElementById('textoAdicionalLinha');
        const produtoPrefixInput = document.getElementById('produtoPrefix');
        const textoFinalMensagemTextarea = document.getElementById('textoFinalMensagem');
        const parcelasAvancadasDiv = document.getElementById('parcelasAvancadas');
        const selectAllButton = document.getElementById('selectAll');
        const deselectAllButton = document.getElementById('deselectAll');
        const textoCabecalhoMensagemTextarea = document.getElementById('textoCabecalhoMensagem');
        const fatorArredondamentoInput = document.getElementById('fatorArredondamento');
        
        const porcentagemPixInput = document.getElementById('porcentagemPix');
        const porcentagemDebitoInput = document.getElementById('porcentagemDebito');
        const porcentagemPixContainer = document.getElementById('porcentagemPixContainer');
        const porcentagemDebitoContainer = document.getElementById('porcentagemDebitoContainer');

        const toggleProductList = document.getElementById('toggleProductList');
        const productListSection = document.getElementById('productListSection');
        const productListTextarea = document.getElementById('productList');
        const productListLoading = document.getElementById('productListLoading');
        const productListResult = document.getElementById('productListResult');
        const aiPromptTextarea = document.getElementById('aiPrompt');

        // Elementos do Hist√≥rico
        const toggleHistorico = document.getElementById('toggleHistorico');
        const historicoSection = document.getElementById('historicoSection');
        const historicoTituloInput = document.getElementById('historicoTitulo');
        const historicoComentariosTextarea = document.getElementById('historicoComentarios');
        const visualizarHistoricoSection = document.getElementById('visualizarHistoricoSection');
        const historicoLista = document.getElementById('historicoLista');

        const taxasDeJurosPadrao = {
            'pix': 0, 1: 0.045, 2: 0.06, 3: 0.07, 4: 0.075, 5: 0.08, 6: 0.09, 7: 0.095, 8: 0.10, 9: 0.105, 10: 0.115, 11: 0.12, 12: 0.125, 13: 0.135, 14: 0.145, 15: 0.15, 16: 0.155, 17: 0.16, 18: 0.17, 'debito': 0.025
        };

        const parcelasPadrao = [3, 6, 10, 12];
        let products = [];
        let selectedProducts = [];

        // ===== FUN√á√ïES DE HIST√ìRICO =====
        
        function toggleHistoricoSection() {
            const checkbox = toggleHistorico;
            const section = historicoSection;
            section.classList.toggle('show', checkbox.checked);
        }

        function toggleVerHistorico() {
            visualizarHistoricoSection.classList.toggle('show');
            if (visualizarHistoricoSection.classList.contains('show')) {
                carregarHistorico();
                // Scroll suave at√© o hist√≥rico
                setTimeout(() => {
                    visualizarHistoricoSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        }

        function abrirHistoricoRapido() {
            // Abrir se√ß√£o de visualiza√ß√£o do hist√≥rico
            if (!visualizarHistoricoSection.classList.contains('show')) {
                visualizarHistoricoSection.classList.add('show');
                carregarHistorico();
            }
            // Scroll suave at√© o hist√≥rico
            visualizarHistoricoSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function atualizarBadgeHistorico() {
            const historico = JSON.parse(localStorage.getItem('historicoCalculos') || '[]');
            const badge = document.getElementById('fabBadge');
            
            if (historico.length > 0) {
                badge.textContent = historico.length > 99 ? '99+' : historico.length;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function obterDataFormatada() {
            const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            const agora = new Date();
            const diaSemana = diasSemana[agora.getDay()];
            const dia = String(agora.getDate()).padStart(2, '0');
            const mes = String(agora.getMonth() + 1).padStart(2, '0');
            const ano = agora.getFullYear();
            const hora = String(agora.getHours()).padStart(2, '0');
            const minuto = String(agora.getMinutes()).padStart(2, '0');
            
            return `${diaSemana}, ${dia}/${mes}/${ano} √†s ${hora}:${minuto}`;
        }

        function obterDadosCalculadora() {
            // Coletar parcelas selecionadas
            const parcelasSelecionadas = [];
            const parcelasTaxas = {};
            document.querySelectorAll('#parcelasAvancadas input[type="checkbox"]:checked').forEach(cb => {
                const num = parseInt(cb.value);
                parcelasSelecionadas.push(num);
                const taxaInput = document.getElementById(`porcentagem${num}x`);
                if (taxaInput) {
                    parcelasTaxas[num] = taxaInput.value;
                }
            });

            return {
                // Valores principais
                valorBase: valorBaseInput.value,
                parcelaEspecifica: parcelaEspecificaInput.value,
                descontoPercentual: descontoPercentualInput.value,
                descontoFixo: descontoFixoInput.value,
                descontoPixExtra: descontoPixExtraInput.value,
                lucroAdicional: lucroAdicionalInput.value,
                valorEntrada: valorEntradaInput.value,
                fatorArredondamento: fatorArredondamentoInput.value,
                
                // Resultado
                resultado: resultadoTextarea.value,
                
                // Lista de produtos
                usandoListaProdutos: toggleProductList.checked,
                listaProdutosTexto: productListTextarea.value,
                produtosSelecionados: selectedProducts,
                todosProdutos: products,
                
                // Op√ß√µes avan√ßadas
                opcoesAvancadasAtivo: toggleAdvancedOptions.checked,
                
                // Checkboxes de texto
                opcoes: {
                    hideDinheiroPix: hideDinheiroPixCheckbox.checked,
                    showDebito: showDebitoCheckbox.checked,
                    showComparison: showComparisonCheckbox.checked,
                    hideEntradaText: hideEntradaTextCheckbox.checked,
                    showTotalValue: showTotalValueCheckbox.checked,
                    boldProductName: boldProductNameCheckbox.checked
                },
                
                // Porcentagens
                porcentagemPix: porcentagemPixInput.value,
                porcentagemDebito: porcentagemDebitoInput.value,
                
                // Textos personalizados
                textos: {
                    produtoPrefix: produtoPrefixInput.value,
                    textoAdicionalLinha: textoAdicionalLinhaInput.value,
                    textoCabecalho: textoCabecalhoMensagemTextarea.value,
                    textoFinal: textoFinalMensagemTextarea.value,
                    aiPrompt: aiPromptTextarea.value
                },
                
                // Parcelas e taxas
                parcelasSelecionadas: parcelasSelecionadas,
                parcelasTaxas: parcelasTaxas
            };
        }

        function salvarNoHistorico() {
            const titulo = historicoTituloInput.value.trim();
            
            if (!titulo) {
                alert('‚ö†Ô∏è Por favor, insira um t√≠tulo para o c√°lculo');
                historicoTituloInput.focus();
                return;
            }

            if (!resultadoTextarea.value) {
                alert('‚ö†Ô∏è N√£o h√° c√°lculo para salvar. Preencha os campos e calcule primeiro.');
                return;
            }

            const historico = JSON.parse(localStorage.getItem('historicoCalculos') || '[]');
            
            const novoRegistro = {
                id: Date.now(),
                data: obterDataFormatada(),
                titulo: titulo,
                comentarios: historicoComentariosTextarea.value.trim(),
                dados: obterDadosCalculadora()
            };

            historico.unshift(novoRegistro); // Adiciona no in√≠cio do array
            localStorage.setItem('historicoCalculos', JSON.stringify(historico));

            // Atualizar badge do FAB
            atualizarBadgeHistorico();

            // Limpar campos do hist√≥rico
            historicoTituloInput.value = '';
            historicoComentariosTextarea.value = '';

            // Mostrar mensagem de sucesso
            mensagemCopiado.textContent = '‚úÖ C√°lculo salvo no hist√≥rico!';
            mensagemCopiado.classList.add('show');
            setTimeout(() => {
                mensagemCopiado.classList.remove('show');
                mensagemCopiado.textContent = '‚úÖ Texto copiado para √°rea de transfer√™ncia!';
            }, 2000);
        }

        function carregarHistorico() {
            const historico = JSON.parse(localStorage.getItem('historicoCalculos') || '[]');
            
            if (historico.length === 0) {
                historicoLista.innerHTML = `
                    <div class="empty-historico">
                        <div class="empty-historico-icon">üì≠</div>
                        <p>Nenhum c√°lculo salvo ainda</p>
                        <small>Salve seus c√°lculos para acess√°-los depois!</small>
                    </div>
                `;
                return;
            }

            let html = '';
            historico.forEach(item => {
                let resumoValor = '';
                
                if (item.dados.usandoListaProdutos && item.dados.produtosSelecionados && item.dados.produtosSelecionados.length > 0) {
                    resumoValor = `${item.dados.produtosSelecionados.length} produto${item.dados.produtosSelecionados.length > 1 ? 's' : ''} selecionado${item.dados.produtosSelecionados.length > 1 ? 's' : ''}`;
                } else if (item.dados.valorBase) {
                    resumoValor = `R$ ${parseFloat(item.dados.valorBase).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                } else {
                    resumoValor = 'Sem valor';
                }

                let detalhesExtras = [];
                if (item.dados.descontoPercentual) detalhesExtras.push(`Desconto: ${item.dados.descontoPercentual}%`);
                if (item.dados.descontoFixo) detalhesExtras.push(`Desc. fixo: R$ ${parseFloat(item.dados.descontoFixo).toFixed(2)}`);
                if (item.dados.lucroAdicional) detalhesExtras.push(`Lucro: R$ ${parseFloat(item.dados.lucroAdicional).toFixed(2)}`);
                if (item.dados.valorEntrada) detalhesExtras.push(`Entrada: R$ ${parseFloat(item.dados.valorEntrada).toFixed(2)}`);
                if (item.dados.parcelaEspecifica) detalhesExtras.push(`Parcela: ${item.dados.parcelaEspecifica}x`);
                
                const detalhesStr = detalhesExtras.length > 0 ? ' | ' + detalhesExtras.join(' | ') : '';

                html += `
                    <div class="historico-item">
                        <div class="historico-header">
                            <div class="historico-titulo">${item.titulo}</div>
                            <div class="historico-data">${item.data}</div>
                        </div>
                        ${item.comentarios ? `<div class="historico-comentarios">üí¨ ${item.comentarios}</div>` : ''}
                        <div class="historico-dados">
                            <strong>Valor:</strong> ${resumoValor}${detalhesStr}
                        </div>
                        <div class="historico-acoes">
                            <button class="btn btn-primary" onclick="restaurarCalculo(${item.id})">üîÑ Restaurar</button>
                            <button class="btn btn-secondary" onclick="copiarResultadoHistorico(${item.id})">üìã Copiar</button>
                            <button class="btn btn-danger" onclick="excluirDoHistorico(${item.id})">üóëÔ∏è Excluir</button>
                        </div>
                    </div>
                `;
            });

            historicoLista.innerHTML = html;
        }

        function restaurarCalculo(id) {
            const historico = JSON.parse(localStorage.getItem('historicoCalculos') || '[]');
            const item = historico.find(h => h.id === id);
            
            if (!item) {
                alert('Registro n√£o encontrado');
                return;
            }

            const dados = item.dados;
            
            // Restaurar valores principais
            valorBaseInput.value = dados.valorBase || '';
            parcelaEspecificaInput.value = dados.parcelaEspecifica || '';
            descontoPercentualInput.value = dados.descontoPercentual || '';
            descontoFixoInput.value = dados.descontoFixo || '';
            descontoPixExtraInput.value = dados.descontoPixExtra || '';
            lucroAdicionalInput.value = dados.lucroAdicional || '';
            valorEntradaInput.value = dados.valorEntrada || '';
            fatorArredondamentoInput.value = dados.fatorArredondamento || '1';
            
            // Restaurar porcentagens
            if (dados.porcentagemPix) porcentagemPixInput.value = dados.porcentagemPix;
            if (dados.porcentagemDebito) porcentagemDebitoInput.value = dados.porcentagemDebito;
            
            // Restaurar textos personalizados
            if (dados.textos) {
                produtoPrefixInput.value = dados.textos.produtoPrefix || '‚û°Ô∏è ';
                textoAdicionalLinhaInput.value = dados.textos.textoAdicionalLinha || '';
                textoCabecalhoMensagemTextarea.value = dados.textos.textoCabecalho || '';
                textoFinalMensagemTextarea.value = dados.textos.textoFinal || '';
                aiPromptTextarea.value = dados.textos.aiPrompt || aiPromptTextarea.value;
            }
            
            // Restaurar lista de produtos
            if (dados.usandoListaProdutos) {
                toggleProductList.checked = true;
                productListTextarea.value = dados.listaProdutosTexto || '';
                
                if (dados.todosProdutos && dados.todosProdutos.length > 0) {
                    products = dados.todosProdutos;
                    displayTable(products);
                    
                    // Marcar produtos selecionados
                    if (dados.produtosSelecionados && dados.produtosSelecionados.length > 0) {
                        selectedProducts = dados.produtosSelecionados;
                        
                        // Marcar os checkboxes correspondentes
                        setTimeout(() => {
                            dados.produtosSelecionados.forEach(prodSelecionado => {
                                const index = products.findIndex(p => 
                                    p.produto === prodSelecionado.produto && 
                                    p.preco === prodSelecionado.preco
                                );
                                if (index !== -1) {
                                    const checkbox = document.querySelector(`.product-checkbox[value="${index}"]`);
                                    if (checkbox) checkbox.checked = true;
                                }
                            });
                        }, 100);
                    }
                }
                
                toggleProductListSection();
            } else {
                toggleProductList.checked = false;
                if (productListSection.classList.contains('show')) {
                    toggleProductListSection();
                }
            }
            
            // Restaurar op√ß√µes
            if (dados.opcoes) {
                hideDinheiroPixCheckbox.checked = dados.opcoes.hideDinheiroPix || false;
                showDebitoCheckbox.checked = dados.opcoes.showDebito || false;
                showComparisonCheckbox.checked = dados.opcoes.showComparison || false;
                hideEntradaTextCheckbox.checked = dados.opcoes.hideEntradaText || false;
                showTotalValueCheckbox.checked = dados.opcoes.showTotalValue || false;
                boldProductNameCheckbox.checked = dados.opcoes.boldProductName !== undefined ? dados.opcoes.boldProductName : true;
            }
            
            // Restaurar op√ß√µes avan√ßadas e parcelas
            if (dados.opcoesAvancadasAtivo) {
                toggleAdvancedOptions.checked = true;
                toggleAdvancedSection();
                
                // Desmarcar todas as parcelas primeiro
                document.querySelectorAll('#parcelasAvancadas input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                    togglePorcentagemInput(parseInt(cb.value), false);
                });
                
                // Restaurar parcelas selecionadas e suas taxas
                if (dados.parcelasSelecionadas && dados.parcelasSelecionadas.length > 0) {
                    dados.parcelasSelecionadas.forEach(numParcela => {
                        const checkbox = document.getElementById(`parcela${numParcela}x`);
                        if (checkbox) {
                            checkbox.checked = true;
                            togglePorcentagemInput(numParcela, true);
                            
                            // Restaurar taxa personalizada se houver
                            if (dados.parcelasTaxas && dados.parcelasTaxas[numParcela]) {
                                const taxaInput = document.getElementById(`porcentagem${numParcela}x`);
                                if (taxaInput) {
                                    taxaInput.value = dados.parcelasTaxas[numParcela];
                                }
                            }
                        }
                    });
                }
            } else {
                toggleAdvancedOptions.checked = false;
                if (advancedOptionsDiv.classList.contains('show')) {
                    toggleAdvancedSection();
                }
            }

            // Fechar hist√≥rico e recalcular
            toggleVerHistorico();
            
            // Atualizar resumo e recalcular
            atualizarResumoDescontos();
            calcularParcelas();
            
            // Scroll para o topo
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            mensagemCopiado.textContent = `‚úÖ C√°lculo "${item.titulo}" restaurado!`;
            mensagemCopiado.classList.add('show');
            setTimeout(() => {
                mensagemCopiado.classList.remove('show');
                mensagemCopiado.textContent = '‚úÖ Texto copiado para √°rea de transfer√™ncia!';
            }, 2000);
        }

        function copiarResultadoHistorico(id) {
            const historico = JSON.parse(localStorage.getItem('historicoCalculos') || '[]');
            const item = historico.find(h => h.id === id);
            
            if (!item || !item.dados.resultado) {
                alert('Resultado n√£o encontrado');
                return;
            }

            navigator.clipboard.writeText(item.dados.resultado).then(() => {
                mensagemCopiado.textContent = `‚úÖ Resultado de "${item.titulo}" copiado!`;
                mensagemCopiado.classList.add('show');
                setTimeout(() => {
                    mensagemCopiado.classList.remove('show');
                    mensagemCopiado.textContent = '‚úÖ Texto copiado para √°rea de transfer√™ncia!';
                }, 2000);
            });
        }

        function excluirDoHistorico(id) {
            if (!confirm('‚ö†Ô∏è Deseja realmente excluir este registro do hist√≥rico?')) {
                return;
            }

            let historico = JSON.parse(localStorage.getItem('historicoCalculos') || '[]');
            historico = historico.filter(h => h.id !== id);
            localStorage.setItem('historicoCalculos', JSON.stringify(historico));
            
            // Atualizar badge do FAB
            atualizarBadgeHistorico();
            
            carregarHistorico();
            
            mensagemCopiado.textContent = '‚úÖ Registro exclu√≠do do hist√≥rico!';
            mensagemCopiado.classList.add('show');
            setTimeout(() => {
                mensagemCopiado.classList.remove('show');
                mensagemCopiado.textContent = '‚úÖ Texto copiado para √°rea de transfer√™ncia!';
            }, 2000);
        }

        function limparHistoricoCompleto() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso ir√° excluir TODOS os registros do hist√≥rico permanentemente. Deseja continuar?')) {
                return;
            }

            localStorage.removeItem('historicoCalculos');
            atualizarBadgeHistorico();
            carregarHistorico();
            
            mensagemCopiado.textContent = '‚úÖ Hist√≥rico completamente limpo!';
            mensagemCopiado.classList.add('show');
            setTimeout(() => {
                mensagemCopiado.classList.remove('show');
                mensagemCopiado.textContent = '‚úÖ Texto copiado para √°rea de transfer√™ncia!';
            }, 2000);
        }

        // ===== FIM DAS FUN√á√ïES DE HIST√ìRICO =====

        // Tema
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // Carregar tema salvo
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.body.setAttribute('data-theme', savedTheme);
        }

        function toggleProductListSection() {
            const checkbox = toggleProductList;
            const section = productListSection;
            section.classList.toggle('show', checkbox.checked);
            
            valorBaseInput.disabled = checkbox.checked;
            if (!checkbox.checked) {
                products = [];
                selectedProducts = [];
                productListResult.innerHTML = '';
            }
            calcularParcelas();
        }

        function toggleAdvancedSection() {
            const checkbox = toggleAdvancedOptions;
            const section = advancedOptionsDiv;
            section.classList.toggle('show', checkbox.checked);
            
            toggleDebitoPixPorcentagemInputs();
            document.querySelectorAll('#parcelasAvancadas input[type="checkbox"]').forEach(cb => 
                togglePorcentagemInput(parseInt(cb.value), cb.checked)
            );
            calcularParcelas();
        }

        // Tornar toda a √°rea do toggle clic√°vel (melhor UX mobile)
        window.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.toggle-section').forEach(section => {
                section.addEventListener('click', function(e) {
                    // Evitar duplo clique se clicar diretamente no checkbox ou label
                    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'LABEL') {
                        const checkbox = this.querySelector('input[type="checkbox"]');
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    }
                });
            });
        });

        // Gerar checkboxes de parcelas
        function gerarCheckboxesAvancadas() {
            parcelasAvancadasDiv.innerHTML = '';
            for (let i = 1; i <= 18; i++) {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                
                const parcelaGroup = document.createElement('div');
                parcelaGroup.className = 'parcela-input-group';
                
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = `parcela${i}x`;
                input.value = i;
                input.checked = parcelasPadrao.includes(i);
                input.addEventListener('change', () => {
                    togglePorcentagemInput(i, input.checked);
                    calcularParcelas();
                });
                
                const label = document.createElement('label');
                label.htmlFor = `parcela${i}x`;
                label.textContent = `${i}x`;
                
                parcelaGroup.appendChild(input);
                parcelaGroup.appendChild(label);
                
                const percentContainer = document.createElement('div');
                percentContainer.className = 'percent-input-container';
                percentContainer.id = `porcentagem${i}xContainer`;
                if (input.checked) percentContainer.classList.add('show');
                
                const percentInput = document.createElement('input');
                percentInput.type = 'number';
                percentInput.id = `porcentagem${i}x`;
                percentInput.value = (taxasDeJurosPadrao[i] * 100).toFixed(2);
                percentInput.addEventListener('input', calcularParcelas);
                
                percentContainer.appendChild(percentInput);
                percentContainer.appendChild(document.createTextNode('%'));
                
                parcelaGroup.appendChild(percentContainer);
                div.appendChild(parcelaGroup);
                parcelasAvancadasDiv.appendChild(div);
            }
        }

        // Processar com IA
        async function processWithAI() {
            const rawText = productListTextarea.value;
            if (!rawText) {
                displayErrorList('Por favor, cole o texto para a IA processar.');
                return;
            }

            productListLoading.classList.add('active');
            productListResult.innerHTML = '';

            try {
                const response = await fetch("https://caixa-kal3.vercel.app/api/groq", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        systemPrompt: aiPromptTextarea.value,
                        messages: rawText
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || data.message || "Erro na requisi√ß√£o");
                }
                
                if (data.choices && data.choices[0]) {
                    productListTextarea.value = data.choices[0].message.content;
                    processList();
                } else {
                    throw new Error("Resposta da IA inv√°lida");
                }
            } catch (error) {
                displayErrorList(`‚ùå Erro na IA: ${error.message}`);
            } finally {
                productListLoading.classList.remove('active');
            }
        }

        function togglePorcentagemInput(parcelas, isChecked) {
            const container = document.getElementById(`porcentagem${parcelas}xContainer`);
            if (container) container.classList.toggle('show', isChecked && toggleAdvancedOptions.checked);
        }

        function toggleDebitoPixPorcentagemInputs() {
            porcentagemPixContainer.classList.toggle('show', !hideDinheiroPixCheckbox.checked && toggleAdvancedOptions.checked);
            porcentagemDebitoContainer.classList.toggle('show', showDebitoCheckbox.checked && toggleAdvancedOptions.checked);
        }

        function arredondarParaMultiplo(valor, fator) {
            if (fator <= 0) fator = 1;
            return Math.ceil(valor / fator) * fator;
        }

        // Calcular desconto total
        function calcularValorComDesconto(valorBase) {
            let valor = valorBase;
            const descontoPerc = parseFloat(descontoPercentualInput.value) || 0;
            const descontoFix = parseFloat(descontoFixoInput.value) || 0;
            
            // Aplicar desconto percentual
            if (descontoPerc > 0) {
                valor = valor * (1 - descontoPerc / 100);
            }
            
            // Aplicar desconto fixo
            if (descontoFix > 0) {
                valor = valor - descontoFix;
            }
            
            return Math.max(0, valor);
        }

        // Atualizar resumo de descontos
        function atualizarResumoDescontos() {
            const base = parseFloat(valorBaseInput.value) || 0;
            if (base === 0) {
                discountSummary.classList.remove('active');
                return;
            }

            const descontoPerc = parseFloat(descontoPercentualInput.value) || 0;
            const descontoFix = parseFloat(descontoFixoInput.value) || 0;
            const descontoPixExtra = parseFloat(descontoPixExtraInput.value) || 0;
            const lucro = parseFloat(lucroAdicionalInput.value) || 0;

            if (descontoPerc === 0 && descontoFix === 0 && descontoPixExtra === 0 && lucro === 0) {
                discountSummary.classList.remove('active');
                return;
            }

            let detalhes = [];
            let valorFinal = base;

            detalhes.push(`üíµ Valor inicial: R$ ${base.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`);

            if (descontoPerc > 0) {
                const valorDesc = base * (descontoPerc / 100);
                valorFinal -= valorDesc;
                detalhes.push(`üìâ Desconto ${descontoPerc}%: -R$ ${valorDesc.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`);
            }

            if (descontoFix > 0) {
                valorFinal -= descontoFix;
                detalhes.push(`üí∏ Desconto fixo: -R$ ${descontoFix.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`);
            }

            if (lucro !== 0) {
                valorFinal += lucro;
                const sinal = lucro > 0 ? '+' : '';
                const icone = lucro > 0 ? 'üìà' : 'üìâ';
                detalhes.push(`${icone} ${lucro > 0 ? 'Acr√©scimo' : 'Redu√ß√£o'}: ${sinal}R$ ${lucro.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`);
            }

            if (descontoPixExtra > 0) {
                const valorPixExtra = valorFinal * (descontoPixExtra / 100);
                detalhes.push(`‚ö° Desconto EXTRA Pix ${descontoPixExtra}%: -R$ ${valorPixExtra.toLocaleString('pt-BR', {minimumFractionDigits: 2})} (s√≥ no Pix)`);
            }

            detalhes.push(`<strong>üí∞ Valor base final: R$ ${valorFinal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong>`);
            
            if (base !== valorFinal) {
                const diferenca = valorFinal - base;
                if (diferenca < 0) {
                    const economia = Math.abs(diferenca);
                    const percEconomia = ((economia / base) * 100).toFixed(1);
                    detalhes.push(`<strong style="color: var(--success-color);">üíö Economia total: R$ ${economia.toLocaleString('pt-BR', {minimumFractionDigits: 2})} (${percEconomia}%)</strong>`);
                } else {
                    const acrescimo = diferenca;
                    const percAcrescimo = ((acrescimo / base) * 100).toFixed(1);
                    detalhes.push(`<strong style="color: var(--accent-color);">üìä Acr√©scimo total: R$ ${acrescimo.toLocaleString('pt-BR', {minimumFractionDigits: 2})} (+${percAcrescimo}%)</strong>`);
                }
            }

            discountDetails.innerHTML = detalhes.join('<br>');
            discountSummary.classList.add('active');
        }

        // Inicializa√ß√£o
        gerarCheckboxesAvancadas();

        // Event Listeners
        valorBaseInput.addEventListener('input', () => {
            valorBaseInput.classList.toggle('has-value', valorBaseInput.value);
            atualizarResumoDescontos();
            calcularParcelas();
        });

        descontoPercentualInput.addEventListener('input', () => {
            atualizarResumoDescontos();
            calcularParcelas();
        });

        descontoFixoInput.addEventListener('input', () => {
            atualizarResumoDescontos();
            calcularParcelas();
        });

        descontoPixExtraInput.addEventListener('input', () => {
            atualizarResumoDescontos();
            calcularParcelas();
        });

        lucroAdicionalInput.addEventListener('input', () => {
            atualizarResumoDescontos();
            calcularParcelas();
        });

        valorEntradaInput.addEventListener('input', calcularParcelas);
        fatorArredondamentoInput.addEventListener('input', calcularParcelas);
        
        hideDinheiroPixCheckbox.addEventListener('change', () => {
            toggleDebitoPixPorcentagemInputs();
            calcularParcelas();
        });

        showDebitoCheckbox.addEventListener('change', () => {
            toggleDebitoPixPorcentagemInputs();
            calcularParcelas();
        });

        showComparisonCheckbox.addEventListener('change', calcularParcelas);
        porcentagemPixInput.addEventListener('input', calcularParcelas);
        porcentagemDebitoInput.addEventListener('input', calcularParcelas);
        hideEntradaTextCheckbox.addEventListener('change', calcularParcelas);
        showTotalValueCheckbox.addEventListener('change', calcularParcelas);
        boldProductNameCheckbox.addEventListener('change', calcularParcelas);
        textoAdicionalLinhaInput.addEventListener('input', calcularParcelas);
        produtoPrefixInput.addEventListener('input', calcularParcelas);
        textoFinalMensagemTextarea.addEventListener('input', calcularParcelas);
        textoCabecalhoMensagemTextarea.addEventListener('input', calcularParcelas);

        parcelaEspecificaInput.addEventListener('input', function() {
            const val = parseInt(this.value);
            
            if (this.value && (isNaN(val) || val < 1 || val > 18)) {
                this.classList.add('invalid');
            } else {
                this.classList.remove('invalid');
            }
            
            calcularParcelas();
        });

        selectAllButton.addEventListener('click', () => {
            document.querySelectorAll('#parcelasAvancadas input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
                togglePorcentagemInput(parseInt(cb.value), true);
            });
            calcularParcelas();
        });

        deselectAllButton.addEventListener('click', () => {
            document.querySelectorAll('#parcelasAvancadas input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
                togglePorcentagemInput(parseInt(cb.value), false);
            });
            calcularParcelas();
        });

        // Lista de produtos
        function processList() {
            const list = productListTextarea.value;
            if (!list) {
                displayErrorList('Por favor, cole a lista de produtos.');
                return;
            }
            
            productListLoading.classList.add('active');
            productListResult.innerHTML = '';
            
            try {
                products = parseProducts(list);
                displayTable(products);
                selectedProducts = [];
                handleProductSelection();
            } catch (error) {
                displayErrorList(`‚ùå Erro: ${error.message}`);
            } finally {
                productListLoading.classList.remove('active');
            }
        }

        function parseProducts(text) {
            const cleanText = text.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]|\u00A9|\u00AE|[\u2000-\u3300]/g, '');
            const lines = cleanText.split('\n');
            const prods = [];
            const priceRegex = /(?:R\$\s*|[-])?\s*([\d\.]+,?\d{2}|\d+)\s*$/;
            
            lines.forEach(line => {
                const trimmed = line.trim();
                if (trimmed.length === 0 || trimmed.match(/^[üìåüì¢‚ìÇÔ∏è‚ú≥Ô∏è‚ùá‚òëÔ∏èüì∫]/)) return;
                
                const match = trimmed.match(priceRegex);
                if (match) {
                    const price = parseFloat(match[1].replace(/\./g, '').replace(',', '.'));
                    const name = trimmed.substring(0, match.index).replace(/`|\*|\-/g, '').trim();
                    if (name && !isNaN(price)) {
                        prods.push({ produto: name, preco: price });
                    }
                }
            });
            
            if (prods.length === 0) throw new Error('Nenhum produto encontrado.');
            return prods;
        }

        function displayTable(prods) {
            let html = '<table><thead><tr><th><input type="checkbox" id="selectAllProducts"></th><th>Produto</th><th>Pre√ßo</th><th>Imagem</th></tr></thead><tbody>';
            
            prods.forEach((p, i) => {
                const price = `R$ ${p.preco.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                html += `<tr>
                    <td><input type="checkbox" class="product-checkbox" value="${i}"></td>
                    <td>${p.produto}</td>
                    <td>${price}</td>
                    <td><a href="https://www.google.com/search?tbm=isch&q=${encodeURIComponent(p.produto)}" target="_blank">Pesquisar</a></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            const badge = `<span class="product-count-badge">${prods.length} produto${prods.length > 1 ? 's' : ''} encontrado${prods.length > 1 ? 's' : ''}</span>`;
            productListResult.innerHTML = badge + html;
            
            document.getElementById('selectAllProducts').addEventListener('change', (e) => {
                document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = e.target.checked);
                handleProductSelection();
            });
            
            document.querySelectorAll('.product-checkbox').forEach(cb => 
                cb.addEventListener('change', handleProductSelection)
            );
        }

        function handleProductSelection() {
            selectedProducts = [];
            document.querySelectorAll('.product-checkbox:checked').forEach(cb => {
                const p = products[parseInt(cb.value)];
                if (p) selectedProducts.push(p);
            });
            calcularParcelas();
        }

        function displayErrorList(msg) {
            productListResult.innerHTML = `<div class="error-message">${msg}</div>`;
        }

        function getTaxa(parcelas) {
            if (toggleAdvancedOptions.checked) {
                if (parcelas === 'pix') return (parseFloat(porcentagemPixInput.value) || 0) / 100;
                if (parcelas === 'debito') return (parseFloat(porcentagemDebitoInput.value) || 0) / 100;
                
                const input = document.getElementById(`porcentagem${parcelas}x`);
                return input ? (parseFloat(input.value) || 0) / 100 : (taxasDeJurosPadrao[parcelas] || 0);
            }
            return taxasDeJurosPadrao[parcelas] || 0;
        }

        function getParcelasSelecionadas() {
            const spec = parseInt(parcelaEspecificaInput.value);
            
            if (!isNaN(spec) && spec > 0 && spec <= 18) {
                return { especifica: true, parcelas: [spec] };
            }
            
            if (toggleAdvancedOptions.checked) {
                const sel = [];
                document.querySelectorAll('#parcelasAvancadas input[type="checkbox"]:checked').forEach(cb => {
                    sel.push(parseInt(cb.value));
                });
                return { especifica: false, parcelas: sel.sort((a,b) => a-b) };
            }
            
            return { especifica: false, parcelas: [...parcelasPadrao] };
        }

        function calcularParcelas() {
            const lucro = parseFloat(lucroAdicionalInput.value) || 0;
            const entrada = parseFloat(valorEntradaInput.value) || 0;
            const res = [];
            const config = getParcelasSelecionadas();

            if (selectedProducts.length > 0) {
                selectedProducts.forEach((p, i) => {
                    let name = boldProductNameCheckbox.checked ? `*${p.produto}*` : p.produto;
                    if (produtoPrefixInput.value) name = `${produtoPrefixInput.value} ${name}`;
                    
                    const r = calcularParcelasParaUmProduto(
                        p.preco,
                        entrada,
                        textoAdicionalLinhaInput.value,
                        showTotalValueCheckbox.checked,
                        name,
                        config,
                        p.preco
                    );
                    
                    if (r) res.push(r);
                    if (i < selectedProducts.length - 1) res.push('\n' + '‚îÅ'.repeat(20));
                });
            } else {
                const base = parseFloat(valorBaseInput.value);
                if (!isNaN(base) && base > 0) {
                    const r = calcularParcelasParaUmProduto(
                        base,
                        entrada,
                        textoAdicionalLinhaInput.value,
                        showTotalValueCheckbox.checked,
                        "",
                        config,
                        base
                    );
                    if (r) res.push(r);
                }
            }

            let final = res;
            if (textoCabecalhoMensagemTextarea.value) {
                final = [`${textoCabecalhoMensagemTextarea.value}\n`, ...res];
            }
            if (textoFinalMensagemTextarea.value) {
                final.push(`\n${textoFinalMensagemTextarea.value}`);
            }
            
            resultadoTextarea.value = final.join('\n');
        }

        function calcularParcelasParaUmProduto(valorBase, ent, txtAdd, showTot, nome, config, valorOriginal) {
            let res = [];
            let fator = parseFloat(fatorArredondamentoInput.value) || 1;
            
            // Aplicar descontos
            let valLiq = calcularValorComDesconto(valorBase);
            
            // Aplicar lucro
            const lucro = parseFloat(lucroAdicionalInput.value) || 0;
            valLiq += lucro;
            
            if (nome) res.push(`${nome}`);
            
            const showEnt = !hideEntradaTextCheckbox.checked && ent > 0;
            const txtEnt = showEnt ? `Entrada de R$ ${ent.toLocaleString('pt-BR', {minimumFractionDigits:2})} + ` : '';
            const aParc = valLiq - ent;

            if (valLiq >= ent) {
                // Dinheiro/Pix
                if (!config.especifica && !hideDinheiroPixCheckbox.checked) {
                    let valorPix = valLiq;
                    
                    // Aplicar desconto extra Pix
                    const descontoPixExtra = parseFloat(descontoPixExtraInput.value) || 0;
                    if (descontoPixExtra > 0) {
                        valorPix = valorPix * (1 - descontoPixExtra / 100);
                    }
                    
                    const v = arredondarParaMultiplo(valorPix / (1 - getTaxa('pix')), fator);
                    let linhaPix = `üí∏ Dinheiro/Pix: R$ ${v.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
                    
                    if (showComparisonCheckbox.checked && valorOriginal !== valLiq) {
                        const economia = valorOriginal - v;
                        linhaPix += ` (economize R$ ${economia.toLocaleString('pt-BR', {minimumFractionDigits:2})})`;
                    }
                    
                    res.push(linhaPix);
                }
                
                // D√©bito
                if (!config.especifica && showDebitoCheckbox.checked && ent === 0) {
                    const v = arredondarParaMultiplo(valLiq / (1 - getTaxa('debito')), fator);
                    res.push(`üí≥ D√©bito: R$ ${v.toLocaleString('pt-BR', {minimumFractionDigits:2})}`);
                }
                
                // Parcelas
                config.parcelas.forEach(p => {
                    const vParc = arredondarParaMultiplo((aParc / (1 - getTaxa(p))) / p, fator);
                    let linha = `üí≥ ${txtEnt}${p}x de R$ ${vParc.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
                    
                    if (showTot) {
                        linha += ` (R$ ${(ent + (vParc * p)).toLocaleString('pt-BR', {minimumFractionDigits:2})})`;
                    }
                    
                    if (txtAdd) linha += ` ${txtAdd}`;
                    res.push(linha);
                });
            }
            
            return res.join('\n');
        }

        function copiarTexto() {
            const txt = resultadoTextarea.value;
            if (!txt) return;
            
            navigator.clipboard.writeText(txt).then(() => {
                mensagemCopiado.classList.add('show');
                setTimeout(() => mensagemCopiado.classList.remove('show'), 2000);
            });
        }

        function limparCampos() {
            if (!confirm('‚ö†Ô∏è Deseja realmente limpar todos os campos?')) return;
            
            valorBaseInput.value = '';
            parcelaEspecificaInput.value = '';
            descontoPercentualInput.value = '';
            descontoFixoInput.value = '';
            descontoPixExtraInput.value = '';
            lucroAdicionalInput.value = '';
            valorEntradaInput.value = '';
            productListTextarea.value = '';
            textoAdicionalLinhaInput.value = '';
            textoCabecalhoMensagemTextarea.value = '';
            textoFinalMensagemTextarea.value = '';
            resultadoTextarea.value = '';
            
            products = [];
            selectedProducts = [];
            productListResult.innerHTML = '';
            
            discountSummary.classList.remove('active');
            valorBaseInput.classList.remove('has-value');
            parcelaEspecificaInput.classList.remove('invalid');
            
            calcularParcelas();
        }

        // Inicializar
        calcularParcelas();
        atualizarBadgeHistorico();
    </script>
</body>
</html>
